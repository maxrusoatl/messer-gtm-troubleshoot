<h1 style="font-size: 64px; line-height: 1.05; margin: 28px 0 14px;">Messer GTM Troubleshoot Report (Condensed)</h1>
<h4 style="font-size: 18px; line-height: 1.2; margin: 6px 0 12px;">Legend</h4>
<ul>
  <li><span style="color:#c0392b; font-weight:700;">Critical</span> = must fix first</li>
  <li><span style="color:#e67e22; font-weight:700;">High</span> = fix after criticals</li>
  <li><span style="color:#7f8c8d; font-weight:700;">ND</span> = Not determinable from provided inputs</li>
</ul>
<p><span style="color:#c0392b; font-weight:700;">Stop rule:</span> Do not move to the next step until the validation line for the current step is true.</p>

<h2 style="font-size: 36px; line-height: 1.15; margin: 22px 0 10px;">What Went Wrong (Confirmed)</h2>
<ul>
  <li><span style="color:#c0392b; font-weight:700;">Critical:</span> /metrics requests returned 400 and sGTM preview is empty, so ingestion is not proven.</li>
  <li><span style="color:#c0392b; font-weight:700;">Critical:</span> event_id is missing in DataLayer samples and not mapped in the Data Tag.</li>
  <li><span style="color:#e67e22; font-weight:700;">High:</span> GA4 server tags overlap on add_to_cart (duplication risk once ingestion works).</li>
  <li><span style="color:#e67e22; font-weight:700;">High:</span> Consent timing flagged late and purchase DataLayer includes raw PII.</li>
</ul>

<h2 style="font-size: 36px; line-height: 1.15; margin: 22px 0 10px;">Step-by-Step Fix Plan (Full, Do in Order)</h2>
<p><strong>Before you start (one-time capture):</strong> Start Tag Assistant for wGTM and sGTM preview, record a full funnel test, and save a /metrics HAR. This is only for proof; fixes below are the real steps.</p>
<ol>
  <li>
    <h3 style="font-size: 24px; line-height: 1.2; margin: 10px 0 6px;"><span style="color:#c0392b;">Step 1 - Fix /metrics 400 (SOP Ingestion)</span></h3>
    <p><strong>Do:</strong> Ensure the sGTM Data Client claims <code>/data</code>. Confirm Worker forwards to <code>https://sgtm.messerattach.com</code> and preserves method/body.</p>
    <p><strong>Validate:</strong> /metrics returns 2xx and sGTM preview shows the Data Client claim for the test event.</p>
  </li>
  <li>
    <h3 style="font-size: 24px; line-height: 1.2; margin: 10px 0 6px;"><span style="color:#c0392b;">Step 2 - Fix Preview Passthrough (Ghost Data)</span></h3>
    <p><strong>Do:</strong> Confirm /metrics requests include preview params/headers (gtm_debug, gtm_auth, gtm_preview, x-gtm-server-preview, x-gtm-server-preview-http-cache-control) and that the Worker forwards them.</p>
    <p><strong>Validate:</strong> sGTM preview shows inbound events for the same browser session.</p>
  </li>
  <li>
    <h3 style="font-size: 24px; line-height: 1.2; margin: 10px 0 6px;"><span style="color:#c0392b;">Step 3 - Decide on Google Tag (/g/collect)</span></h3>
    <p><strong>Do:</strong> If Google Tag is required, add a GA4 Client in sGTM to claim <code>/g/collect</code>. If not required, disable Google Tag via /metrics.</p>
    <p><strong>Validate:</strong> /metrics/<code>&lt;id&gt;</code> no longer returns 400 or is removed from traffic.</p>
  </li>
  <li>
    <h3 style="font-size: 24px; line-height: 1.2; margin: 10px 0 6px;"><span style="color:#c0392b;">Step 4 - Add event_id End-to-End</span></h3>
    <p><strong>Do:</strong> Map {{Unique Event ID}} into the Data Tag payload as <code>event_id</code> and pass it into GA4/Ads/Meta tag mappings in sGTM.</p>
    <p><strong>Validate:</strong> event_id is visible in sGTM preview and in GA4/Ads tag payloads.</p>
  </li>
  <li>
    <h3 style="font-size: 24px; line-height: 1.2; margin: 10px 0 6px;"><span style="color:#e67e22;">Step 5 - Normalize transaction_id</span></h3>
    <p><strong>Do:</strong> Ensure transaction_id has one consistent format (no leading #) across DataLayer, /metrics payload, and sGTM eventData.</p>
    <p><strong>Validate:</strong> Same transaction_id value appears in DataLayer, sGTM preview, and GA4 DebugView.</p>
  </li>
  <li>
    <h3 style="font-size: 24px; line-height: 1.2; margin: 10px 0 6px;"><span style="color:#e67e22;">Step 6 - Fix Consent Timing and Enforcement</span></h3>
    <p><strong>Do:</strong> Ensure Complianz consent update fires before ecommerce events and consent_state is forwarded to sGTM.</p>
    <p><strong>Validate:</strong> No wasSetLate flag and consent values are visible in sGTM preview.</p>
  </li>
  <li>
    <h3 style="font-size: 24px; line-height: 1.2; margin: 10px 0 6px;"><span style="color:#e67e22;">Step 7 - Remove GA4 add_to_cart Duplication</span></h3>
    <p><strong>Do:</strong> Keep only one GA4 server tag firing on add_to_cart (remove or tighten the other).</p>
    <p><strong>Validate:</strong> Exactly one GA4 server tag fires for add_to_cart in preview.</p>
  </li>
  <li>
    <h3 style="font-size: 24px; line-height: 1.2; margin: 10px 0 6px;"><span style="color:#e67e22;">Step 8 - Handle PII Safely</span></h3>
    <p><strong>Do:</strong> Hash email/phone before sending. Do not send raw PII to GA4.</p>
    <p><strong>Validate:</strong> No raw PII in payloads; only hashed data in allowed destinations.</p>
  </li>
  <li>
    <h3 style="font-size: 24px; line-height: 1.2; margin: 10px 0 6px;">Step 9 - Final End-to-End Verification</h3>
    <p><strong>Do:</strong> Run a clean test purchase and confirm each layer: DataLayer → wGTM → /metrics → sGTM → GA4 DebugView.</p>
    <p><strong>Validate:</strong> GA4 DebugView shows events with event_id and full ecommerce payload.</p>
  </li>
</ol>

<h2 style="font-size: 36px; line-height: 1.15; margin: 22px 0 10px;">Evidence Gaps (Still Needed)</h2>
<ul>
  <li>sGTM preview capture with ecommerce events (client claim + tag firing).</li>
  <li>/metrics HAR (method, headers, content-type, payload, preview headers).</li>
  <li>Cloudflare Worker route, header transforms, cache/WAF/Bot rules, and DNS records.</li>
  <li>WP Rocket exclusions for /metrics/*.</li>
  <li>Stape logs with event hits (path/status/event_id).</li>
</ul>
