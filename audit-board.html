<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GTM Audit Board</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="alternate icon" href="/favicon.ico" />
  <style>
    :root { --bg:#0f1115; --panel:#151821; --muted:#8a93a6; --text:#e8ecf1; --accent:#6ea8fe; --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; }
    body { margin:0; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); }
    header { display:flex; align-items:center; gap:12px; padding:12px 16px; background:#0d1018; position:sticky; top:0; z-index:2; border-bottom:1px solid #212638; }
    h1 { font-size:16px; margin:0; font-weight:600; }
    .pill { background:#1b2030; border:1px solid #26304a; color:var(--muted); padding:6px 10px; border-radius:8px; font-size:12px; }
    .container { display:grid; grid-template-columns: 300px 1fr; gap:12px; padding:12px; }
    .side { display:flex; flex-direction:column; gap:12px; }
    .panel { background:var(--panel); border:1px solid #212638; border-radius:10px; overflow:hidden; }
    .panel h2 { font-size:14px; margin:0; padding:10px 12px; border-bottom:1px solid #212638; color:#c9d3e7; }
    .panel .content { padding:10px 12px; }
    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    input[type="text"] { background:#0f1320; border:1px solid #26304a; color:var(--text); padding:8px 10px; border-radius:8px; outline:none; width:100%; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; }
    .chip { cursor:pointer; font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid #26304a; background:#0f1320; color:#c9d3e7; user-select:none; }
    .chip.active { background:#14213a; border-color:#3856a3; color:#9ec1ff; }
    .actions { display:flex; gap:8px; flex-wrap: wrap; }
    button { background:#0f1320; border:1px solid #26304a; color:#c9d3e7; padding:8px 10px; border-radius:8px; cursor:pointer; }
    button:hover { border-color:#3856a3; }
    table { width:100%; border-collapse:collapse; font-size:12.5px; }
    th, td { border-bottom:1px solid #212638; padding:8px 8px; text-align:left; vertical-align:top; }
    th { color:#aab6cf; position:sticky; top:0; background:var(--panel); z-index:1; }
    tr:hover td { background:#151b2a; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #2a3658; background:#0f1320; color:#c9d3e7; }
    .dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
    .ok { background:var(--ok); }
    .warn { background:var(--warn); }
    .bad { background:var(--bad); }
    .muted { color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .scroll { max-height: 60vh; overflow:auto; }
    .small { font-size:12px; }
    .nowrap { white-space:nowrap; }
    .expander { cursor: pointer; color:#9ec1ff; }
    .hidden { display:none; }
  </style>
  <script>
  // Minimal helpers reused across pages
  function getParam(tag, name) {
    const p = (tag && tag.parameter) || [];
    const found = p.find(x => x.key === name);
    if (!found) return undefined;
    if (found.type === 'TEMPLATE' || found.type === 'BOOLEAN' || found.type === 'INTEGER' || found.type === 'STRING'){ return found.value; }
    if (found.type === 'LIST') return (found.list || []).map(v => v.value);
    if (found.type === 'MAP') return Object.fromEntries((found.map || []).map(m => [m.key, m.value]));
    return found.value ?? found;
  }
  function classifyTag(t) {
    const tname = (t && (t.tagFiringOption ? t.tagFiringOption.type : '')) || '';
    const name = (t && t.name || '').toLowerCase();
    const type = (t && t.type || '').toLowerCase();
    if (type.includes('ga4') || name.includes('ga4')) return 'GA4';
    if (name.includes('google ads') || type.includes('aw_') || name.includes('adwords')) return 'Google Ads';
    if (name.includes('meta') || name.includes('facebook') || type.includes('fb')) return 'Meta';
    if (name.includes('linkedin')) return 'LinkedIn';
    if (name.includes('microsoft') || name.includes('bing') || name.includes('uet')) return 'Microsoft Ads';
    return 'Other';
  }
  function deriveDestination(t) {
    const vendor = classifyTag(t);
    if (vendor === 'GA4') {
      const mid = getParam(t, 'measurementId') || getParam(t, 'measurement_id');
      const ds = getParam(t, 'sendEcommerceData') ? 'with ecommerce' : '';
      return mid ? `GA4 ${mid} ${ds}`.trim() : 'GA4 tag';
    }
    if (vendor === 'Google Ads') {
      const cid = getParam(t, 'conversionId');
      const lbl = getParam(t, 'conversionLabel');
      const fmt = [cid, lbl].filter(Boolean).join('/');
      return fmt || 'Ads conversion';
    }
    if (vendor === 'Meta') {
      const pid = getParam(t, 'pixelId') || getParam(t, 'pixel_id');
      const evt = getParam(t, 'eventName') || getParam(t, 'event_name');
      return [pid, evt].filter(Boolean).join(' · ') || 'Meta pixel';
    }
    if (vendor === 'LinkedIn') {
      const pid = getParam(t, 'partnerId') || getParam(t, 'linkedinId') || getParam(t, 'li_fpt_id');
      return pid ? `LinkedIn ${pid}` : 'LinkedIn Insight';
    }
    if (vendor === 'Microsoft Ads') {
      const tagId = getParam(t, 'uetId') || getParam(t, 'tagId');
      return tagId ? `UET ${tagId}` : 'Microsoft Ads UET';
    }
    return t.type || 'Tag';
  }
  function payloadPreview(t) {
    const vendor = classifyTag(t);
    if (vendor === 'GA4') {
      const mid = getParam(t, 'measurementId') || getParam(t, 'measurement_id');
      const evt = getParam(t, 'eventName') || getParam(t, 'event_name');
      return [mid?`mid:${mid}`:null, evt?`evt:${evt}`:null].filter(Boolean).join(' • ') || '—';
    }
    if (vendor === 'Google Ads') {
      const cid = getParam(t, 'conversionId');
      const lbl = getParam(t, 'conversionLabel');
      return [cid?`cid:${cid}`:null, lbl?`lbl:${lbl}`:null].filter(Boolean).join(' / ') || '—';
    }
    if (vendor === 'Meta') {
      const pid = getParam(t, 'pixelId') || getParam(t, 'pixel_id');
      const evt = getParam(t, 'eventName') || getParam(t, 'event_name');
      return [pid?`pixel:${pid}`:null, evt?`evt:${evt}`:null].filter(Boolean).join(' • ') || '—';
    }
    if (vendor === 'LinkedIn') {
      const pid = getParam(t, 'partnerId') || getParam(t, 'linkedinId') || getParam(t, 'li_fpt_id');
      return pid?`pid:${pid}`:'—';
    }
    if (vendor === 'Microsoft Ads') {
      const tagId = getParam(t, 'uetId') || getParam(t, 'tagId');
      return tagId?`uet:${tagId}`:'—';
    }
    return '—';
  }
  function consentInfo(t) {
    const cs = (t && t.consentSettings) || {};
    const list = cs.consentTypes || cs.consentType || cs.requiredConsentTypes || [];
    return Array.isArray(list) ? list : [];
  }
  function downloadCSV(filename, rows) {
    const csv = rows.map(r => r.map(v => {
      const s = (v===undefined||v===null) ? '' : String(v);
      if (s.includes(',') || s.includes('"') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    }).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  async function loadJSON(path) {
    const r = await fetch(path);
    if (!r.ok) throw new Error('Failed to load '+path);
    return r.json();
  }
  async function loadContainers() {
    const files = ['GTM-MNRP4PF_workspace247.json','GTM-K3CQBMZ9_workspace36.json'];
    const out = [];
    for (const f of files) {
      try { out.push({ name:f, data: await loadJSON(f) }); } catch {}
    }
    return out;
  }
  async function loadEventChunks() {
    const base = 'chunked_output/tag_assistant_messerattach_com_2025_12_24_messages_chunk_';
    const events = [];
    let misses=0;
    for (let i=1;i<=400;i++){
      const f = base + i + '.json';
      try {
        const arr = await loadJSON(f);
        if (Array.isArray(arr)) events.push(...arr);
        misses = 0;
      } catch(e) {
        misses++;
        if (misses>=3) break;
      }
    }
    return events;
  }

  function normalizeEventName(msg) {
    const cands = [
      msg?.message?.eventName,
      msg?.message?.eventNameKey,
      msg?.message?.event,
      msg?.data?.eventName,
      msg?.data?.event_name,
      msg?.data?.event,
      msg?.event,
      msg?.name,
    ];
    return (cands.find(Boolean) || '').toString();
  }

  function getConsentMap(msg){
    const cd = msg?.message?.consentData || msg?.consentData || msg?.data?.consentData || {};
    const out = {};
    const keys = ['ad_storage','analytics_storage','functionality_storage','personalization_storage','security_storage'];
    // Prefer fullConsentList with isConsentGranted booleans
    const fcl = cd?.fullConsentList;
    if (fcl && typeof fcl === 'object') {
      for (const k of keys) out[k] = fcl?.[k]?.isConsentGranted;
      return out;
    }
    // Fallback: consentList array of {type,status}
    const list = Array.isArray(cd?.consentList) ? cd.consentList : [];
    const map = Object.fromEntries(list.map(x => [x.type, String(x.status||'').toLowerCase() === 'granted']));
    for (const k of keys) out[k] = map[k];
    return out;
  }
  function getFiredTags(msg){
    const out = new Set();
    // Tag Assistant: message.tagInfo array with objects that include tag names
    const tagInfo = msg?.message?.tagInfo;
    if (Array.isArray(tagInfo)) {
      for (const ti of tagInfo){
        const nm = ti?.name || ti?.displayName || ti?.type;
        if (nm) out.add(String(nm));
      }
    }
    // Additional fallbacks
    const addFromArr = (arr)=>{
      if (!Array.isArray(arr)) return;
      for (const t of arr){
        const name = t?.name || t?.tagName || t?.title || t?.displayName;
        if (name) out.add(String(name));
      }
    };
    addFromArr(msg?.tags);
    addFromArr(msg?.data?.tags);
    addFromArr(msg?.message?.tags);
    addFromArr(msg?.tagReports);
    const single = msg?.tag?.name || msg?.tagName || msg?.message?.tagName;
    if (single) out.add(String(single));
    return out;
  }

  function buildData(containers, events) {
    // Using the first WEB-like container for tags/triggers
    const web = containers.find(c => /GTM-MNRP4PF|workspace/i.test(c.name))?.data || containers[0]?.data || {};
    const tags = web.tag || [];
    const triggers = web.trigger || [];
    const trigById = Object.fromEntries(triggers.map(t => [t.triggerId, t]));

    // Precompute runtime metrics per tag
    const eventRecs = events.map(e => ({
      name: normalizeEventName(e) || '(unknown)',
      consent: getConsentMap(e),
      fired: getFiredTags(e)
    }));

    const tagRows = tags.map(t => {
      const vendor = classifyTag(t);
      const cons = consentInfo(t);
      const trigNames = (t.firingTriggerId || []).map(id => trigById[id]?.name || id);
      const dest = deriveDestination(t);
      const payload = payloadPreview(t);
      // Runtime metrics
      let fired=0, gated=0, violations=0;
      for (const ev of eventRecs){
        const needed = cons;
        const hasAll = !needed.length || needed.every(ct => ev.consent[ct] !== false);
        const firedHere = ev.fired.has(t.name);
        if (firedHere) fired++;
        if (!hasAll) {
          gated++;
          if (firedHere) violations++;
        }
      }
      const metrics = { fired, gated, violations };
      return { name: t.name || '(unnamed)', vendor, triggers: trigNames, consent: cons, destination: dest, payload, metrics, raw: t };
    });

    const consentTypes = ['ad_storage','analytics_storage','functionality_storage','personalization_storage','security_storage'];

    const eventCounts = new Map();
    const eventTags = new Map();
    for (const e of events) {
      const nm = normalizeEventName(e) || '(unknown)';
      eventCounts.set(nm, (eventCounts.get(nm)||0)+1);
      const fired = getFiredTags(e);
      if (!eventTags.has(nm)) eventTags.set(nm, new Set());
      const s = eventTags.get(nm);
      for (const t of fired) s.add(t);
    }
    const eventRows = [...eventCounts.entries()].map(([name,count])=>({
      name,
      count,
      tags: [...(eventTags.get(name)||new Set())].sort((a,b)=>a.localeCompare(b))
    })).sort((a,b)=>b.count-a.count);

    return { tagRows, consentTypes, eventRows };
  }

  function renderTagsTable(rows) {
    const tbody = document.querySelector('#tags-tbody');
    tbody.innerHTML = '';
    for (const r of rows) {
      const tr = document.createElement('tr');
      const tdName = document.createElement('td');
      tdName.innerHTML = `<div class="row"><span class="badge"><span class="dot ${r.vendor==='Other'?'warn':'ok'}"></span>${r.vendor}</span><span class="mono">${escapeHtml(r.name)}</span></div>`;
      const tdTrig = document.createElement('td');
      tdTrig.innerHTML = r.triggers.length ? r.triggers.map(x=>`<span class="badge small">${escapeHtml(x)}</span>`).join(' ') : '<span class="muted">—</span>';
      const tdCons = document.createElement('td');
      tdCons.innerHTML = r.consent.length ? r.consent.map(x=>`<span class="badge small">${escapeHtml(x)}</span>`).join(' ') : '<span class="muted">None</span>';
      const tdFired = document.createElement('td');
      tdFired.textContent = r.metrics.fired;
      const tdGated = document.createElement('td');
      tdGated.textContent = r.metrics.gated;
      const tdViol = document.createElement('td');
      tdViol.innerHTML = r.metrics.violations ? `<span class="badge" style="border-color:#5a2730;color:#ffc9c9;background:#2a0f13;">${r.metrics.violations} violations</span>` : '<span class="muted">0</span>';
      const tdDest = document.createElement('td');
      tdDest.textContent = r.destination;
      const tdPayload = document.createElement('td');
      tdPayload.textContent = r.payload;
      const tdActions = document.createElement('td');
      tdActions.innerHTML = `<button class="small" data-json>Raw JSON</button>`;
      tdActions.querySelector('button[data-json]').onclick = () => showJSON(r.raw, r.name);
      tr.append(tdName, tdTrig, tdCons, tdFired, tdGated, tdViol, tdDest, tdPayload, tdActions);
      tbody.appendChild(tr);
    }
  }

  function renderConsentMatrix(rows, types) {
    const thead = document.querySelector('#consent-thead');
    const tbody = document.querySelector('#consent-tbody');
    thead.innerHTML = '<tr><th class="nowrap">Tag</th>' + types.map(t=>`<th class="nowrap">${escapeHtml(t)}</th>`).join('') + '</tr>';
    tbody.innerHTML = '';
    for (const r of rows) {
      const tr = document.createElement('tr');
      const tdName = document.createElement('td');
      tdName.textContent = r.name;
      tr.appendChild(tdName);
      for (const t of types) {
        const has = r.consent.includes(t);
        const td = document.createElement('td');
        td.innerHTML = has ? '<span class="dot ok"></span>' : '<span class="muted">—</span>';
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }

  function renderEventsTable(rows) {
    const tbody = document.querySelector('#events-tbody');
    tbody.innerHTML = '';
    for (const r of rows) {
      const tr = document.createElement('tr');
      const tdName = document.createElement('td');
      tdName.innerHTML = `${escapeHtml(r.name)} <span class="expander">▸</span>`;
      const tdCount = document.createElement('td');
      tdCount.textContent = r.count;
      tr.append(tdName, tdCount);
      tbody.appendChild(tr);

      const detailTr = document.createElement('tr');
      const detailTd = document.createElement('td');
      detailTd.colSpan = 2;
      const tagsHtml = r.tags.length ? r.tags.map(x=>`<span class="badge small">${escapeHtml(x)}</span>`).join(' ') : '<span class="muted">No tags observed</span>';
      detailTd.innerHTML = `<div class="content" style="padding:8px 0;">${tagsHtml}</div>`;
      detailTr.className = 'hidden';
      detailTr.appendChild(detailTd);
      tbody.appendChild(detailTr);

      tdName.querySelector('.expander').onclick = () => {
        const isHidden = detailTr.classList.contains('hidden');
        detailTr.classList.toggle('hidden', !isHidden);
        tdName.querySelector('.expander').textContent = isHidden ? '▾' : '▸';
      };
    }
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  function filterRows(allRows) {
    const q = document.querySelector('#search').value.trim().toLowerCase();
    const act = [...document.querySelectorAll('.chip[data-vendor]')].filter(x=>x.classList.contains('active')).map(x=>x.getAttribute('data-vendor'));
    const vioOnly = document.querySelector('#violations-only')?.classList.contains('active');
    return allRows.filter(r => {
      const hitQ = !q || r.name.toLowerCase().includes(q) || r.triggers.some(t=>t.toLowerCase().includes(q)) || r.destination.toLowerCase().includes(q);
      const hitV = !act.length || act.includes(r.vendor);
      const hitViol = !vioOnly || (r.metrics && r.metrics.violations > 0);
      return hitQ && hitV && hitViol;
    });
  }

  function setupVendorChips(rows){
    const vendors = ['GA4','Google Ads','Meta','LinkedIn','Microsoft Ads','Other'];
    const cont = document.querySelector('#vendor-chips');
    cont.innerHTML = '';
    for (const v of vendors) {
      const count = rows.filter(r=>r.vendor===v).length;
      const el = document.createElement('span');
      el.className = 'chip';
      el.setAttribute('data-vendor', v);
      el.textContent = `${v} (${count})`;
      el.onclick = () => { el.classList.toggle('active'); refreshViews(); };
      cont.appendChild(el);
    }
    const vio = document.createElement('span');
    vio.className = 'chip';
    vio.id = 'violations-only';
    vio.textContent = 'Violations only';
    vio.title = 'Show only tags that fired despite missing required consent';
    vio.onclick = () => { vio.classList.toggle('active'); refreshViews(); };
    cont.appendChild(vio);
  }

  function exportTagsCSV(rows){
    const csvRows = [['Tag','Vendor','Triggers','Consent','Fired','Gated','Violations','Destination','Payload']];
    for (const r of rows) csvRows.push([r.name, r.vendor, r.triggers.join('; '), r.consent.join('; '), r.metrics.fired, r.metrics.gated, r.metrics.violations, r.destination, r.payload]);
    downloadCSV('gtm_tags.csv', csvRows);
  }
  function exportEventsCSV(rows){
    const csvRows = [['Event','Count']];
    for (const r of rows) csvRows.push([r.name, r.count]);
    downloadCSV('events_coverage.csv', csvRows);
  }

  let STATE = { allTagRows: [], filtered: [], consentTypes: [], eventRows: [] };
  function refreshViews(){
    const rows = filterRows(STATE.allTagRows);
    STATE.filtered = rows;
    renderTagsTable(rows);
    renderConsentMatrix(rows, STATE.consentTypes);
    document.querySelector('#tags-count').textContent = rows.length;
  }

  function showJSON(obj, title){
    const pre = document.querySelector('#json-pre');
    const ttl = document.querySelector('#json-title');
    ttl.textContent = title || 'Raw JSON';
    pre.textContent = JSON.stringify(obj, null, 2);
  }

  window.addEventListener('DOMContentLoaded', async () => {
    const headerStatus = document.querySelector('#status');
    headerStatus.textContent = 'Loading…';
    try {
      const [containers, events] = await Promise.all([loadContainers(), loadEventChunks()]);
      const { tagRows, consentTypes, eventRows } = buildData(containers, events);
      STATE.allTagRows = tagRows;
      STATE.consentTypes = consentTypes;
      STATE.eventRows = eventRows;
      setupVendorChips(tagRows);
      refreshViews();
      renderEventsTable(eventRows);
      document.querySelector('#events-count').textContent = eventRows.length;
      headerStatus.textContent = `Tags: ${tagRows.length} · Events: ${eventRows.length}`;
    } catch (e) {
      headerStatus.textContent = 'Failed to load data';
      console.error(e);
    }

    document.querySelector('#search').addEventListener('input', refreshViews);
    document.querySelector('#export-tags').onclick = () => exportTagsCSV(STATE.filtered);
    document.querySelector('#export-events').onclick = () => exportEventsCSV(STATE.eventRows);
  });
  </script>
</head>
<body>
  <header>
    <h1>GTM Audit Board</h1>
    <span class="pill" id="status">Ready</span>
  </header>
  <div class="container">
    <div class="side">
      <div class="panel">
        <h2>Filters</h2>
        <div class="content" style="display:flex;flex-direction:column;gap:10px;">
          <input type="text" id="search" placeholder="Search tags, triggers, destinations…" />
          <div class="chips" id="vendor-chips"></div>
          <div class="actions">
            <button id="export-tags">Export Tags CSV</button>
            <button id="export-events">Export Events CSV</button>
          </div>
        </div>
      </div>
      <div class="panel">
        <h2>Raw Inspector</h2>
        <div class="content">
          <div class="small muted" id="json-title">Select a row to inspect raw JSON</div>
          <div class="scroll"><pre class="mono small" id="json-pre"></pre></div>
        </div>
      </div>
    </div>
    <div class="main">
      <div class="panel" style="margin-bottom:12px;">
        <h2>Tags <span class="muted" id="tags-count"></span></h2>
        <div class="content scroll">
          <table>
            <thead>
              <tr>
                <th>Tag · Vendor</th>
                <th>Firing Triggers</th>
                <th>Consent</th>
                <th>Fired</th>
                <th>Gated</th>
                <th>Violations</th>
                <th>Destination</th>
                <th>Payload</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tags-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <h2>Consent Matrix</h2>
        <div class="content scroll">
          <table>
            <thead id="consent-thead"></thead>
            <tbody id="consent-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h2>Events Coverage <span class="muted" id="events-count"></span></h2>
        <div class="content scroll">
          <table>
            <thead>
              <tr><th>Event</th><th>Count</th></tr>
            </thead>
            <tbody id="events-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
