<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Messer GTM Canvas - React Flow</title>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- React Flow (older package with UMD support) -->
  <script src="https://unpkg.com/reactflow@11/dist/umd/index.js" crossorigin></script>
  <link href="https://unpkg.com/reactflow@11/dist/style.css" rel="stylesheet" />

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0d1117;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    #root {
      height: 100%;
      width: 100%;
    }

    /* Navigation */
    .nav-menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: rgba(15, 15, 26, 0.98);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #2d3a5a;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      gap: 20px;
    }

    .nav-logo {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #4caf50, #2196f3);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .nav-links {
      display: flex;
      gap: 5px;
    }

    .nav-link {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #aaa;
      text-decoration: none;
      transition: all 0.2s;
    }

    .nav-link:hover { background: #16213e; color: #fff; }
    .nav-link.active { background: #2196f3; color: #fff; }

    .nav-status {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }

    .nav-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .nav-badge.critical { background: #f44336; color: #fff; }
    .nav-badge.medium { background: #ff9800; color: #fff; }
    .nav-badge.verified { background: #4caf50; color: #fff; }

    /* View Toggle */
    .view-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 20px;
      padding-left: 20px;
      border-left: 1px solid #2d3a5a;
    }

    .view-toggle-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .view-toggle-buttons {
      display: flex;
      background: #16213e;
      border-radius: 6px;
      padding: 2px;
    }

    .view-toggle-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      background: transparent;
      color: #888;
    }

    .view-toggle-btn:hover {
      color: #fff;
    }

    .view-toggle-btn.active {
      background: #f44336;
      color: #fff;
    }

    .view-toggle-btn.active.target {
      background: #4caf50;
    }

    .view-mode-indicator {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      z-index: 998;
      pointer-events: none;
    }

    .view-mode-indicator.current {
      background: rgba(244, 67, 54, 0.9);
      color: #fff;
    }

    .view-mode-indicator.target {
      background: rgba(76, 175, 80, 0.9);
      color: #fff;
    }

    /* Recommendation boxes in nodes */
    .recommendation-box {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      border: 1px dashed;
    }

    .recommendation-box.current {
      background: rgba(244, 67, 54, 0.1);
      border-color: #f44336;
    }

    .recommendation-box.recommended {
      background: rgba(76, 175, 80, 0.1);
      border-color: #4caf50;
    }

    .recommendation-box-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .recommendation-box.current .recommendation-box-title {
      color: #f44336;
    }

    .recommendation-box.recommended .recommendation-box-title {
      color: #4caf50;
    }

    .recommendation-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .recommendation-list li {
      font-size: 11px;
      color: #ccc;
      padding: 3px 0;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }

    .recommendation-list li::before {
      content: '‚Üí';
      color: #666;
    }

    .recommendation-box.recommended .recommendation-list li::before {
      content: '‚úì';
      color: #4caf50;
    }

    /* Target view styling for ghost nodes */
    .custom-node.ghost {
      opacity: 0.6;
      border-style: dashed;
    }

    .custom-node.new-recommended {
      border-color: #4caf50;
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
    }

    /* Left Toolbar */
    .toolbar {
      position: fixed;
      top: 50px;
      left: 0;
      width: 44px;
      height: calc(100vh - 50px);
      background: rgba(15, 15, 26, 0.98);
      border-right: 1px solid #2d3a5a;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      gap: 4px;
      z-index: 999;
    }

    .toolbar-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: #888;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .toolbar-btn:hover {
      background: #16213e;
      color: #fff;
    }

    .toolbar-btn.active {
      background: #2196f3;
      color: #fff;
    }

    .toolbar-btn svg {
      width: 18px;
      height: 18px;
    }

    .toolbar-divider {
      width: 24px;
      height: 1px;
      background: #2d3a5a;
      margin: 8px 0;
    }

    .toolbar-hint {
      position: absolute;
      left: 48px;
      background: rgba(22, 33, 62, 0.98);
      border: 1px solid #2d3a5a;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 11px;
      color: #fff;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s;
    }

    .toolbar-btn:hover .toolbar-hint {
      opacity: 1;
    }

    .toolbar-hint kbd {
      background: #2d3a5a;
      padding: 2px 5px;
      border-radius: 3px;
      margin-left: 8px;
      font-family: inherit;
      font-size: 10px;
    }

    /* Flow Container */
    .flow-container {
      width: calc(100% - 44px);
      height: calc(100vh - 50px);
      margin-top: 50px;
      margin-left: 44px;
      background: #0d1117;
    }

    /* React Flow Overrides */
    .react-flow__background {
      background-color: #0d1117 !important;
    }

    .react-flow__minimap {
      background: rgba(22, 33, 62, 0.95) !important;
      border: 1px solid #2d3a5a !important;
      border-radius: 8px !important;
    }

    .react-flow__controls {
      background: rgba(22, 33, 62, 0.95) !important;
      border: 1px solid #2d3a5a !important;
      border-radius: 8px !important;
    }

    .react-flow__controls-button {
      background: transparent !important;
      border-bottom: 1px solid #2d3a5a !important;
      fill: #aaa !important;
    }

    .react-flow__controls-button:hover {
      background: #2d3a5a !important;
      fill: #fff !important;
    }

    /* MiniMap Toggle */
    .minimap-toggle {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 5;
      background: rgba(22, 33, 62, 0.95);
      border: 1px solid #2d3a5a;
      border-radius: 6px;
      padding: 6px 10px;
      color: #aaa;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .minimap-toggle:hover {
      background: #2d3a5a;
      color: #fff;
    }

    .minimap-wrapper {
      position: absolute;
      bottom: 50px;
      right: 20px;
      z-index: 4;
    }

    .minimap-wrapper.collapsed {
      display: none;
    }

    /* Custom Node Styles */
    .custom-node {
      background: #16213e;
      border: 2px solid #2d3a5a;
      border-radius: 12px;
      min-width: 220px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      position: relative;
      z-index: 1;
    }

    /* Ensure nodes don't block tooltips */
    .react-flow__node {
      z-index: 1 !important;
    }

    .react-flow__node:hover {
      z-index: 2 !important;
    }

    .custom-node:hover {
      border-color: #4a6a9a;
    }

    .custom-node.woo { border-color: #96588a; }
    .custom-node.complianz { border-color: #00a0d2; }
    .custom-node.wgtm { border-color: #ff9800; }
    .custom-node.sgtm { border-color: #4caf50; }
    .custom-node.stape { border-color: #00bcd4; }
    .custom-node.proxy { border-color: #f48120; }
    .custom-node.ga4 { border-color: #f9ab00; }
    .custom-node.gads { border-color: #4285f4; }
    .custom-node.meta { border-color: #0668e1; }
    .custom-node.linkedin { border-color: #0077b5; }
    .custom-node.msads { border-color: #00a4ef; }

    .node-header {
      padding: 12px 15px;
      border-bottom: 1px solid #2d3a5a;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .node-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
    }

    .node-icon.woo { background: linear-gradient(135deg, #96588a, #674399); }
    .node-icon.complianz { background: linear-gradient(135deg, #00a0d2, #005a87); }
    .node-icon.wgtm { background: linear-gradient(135deg, #4285f4, #34a853); }
    .node-icon.sgtm { background: linear-gradient(135deg, #34a853, #0f9d58); }
    .node-icon.stape { background: linear-gradient(135deg, #00bcd4, #0097a7); }
    .node-icon.proxy { background: linear-gradient(135deg, #f48120, #fbbd23); }
    .node-icon.ga4 { background: linear-gradient(135deg, #f9ab00, #e37400); }
    .node-icon.gads { background: linear-gradient(135deg, #4285f4, #1a73e8); }
    .node-icon.meta { background: linear-gradient(135deg, #0668e1, #0866ff); }
    .node-icon.linkedin { background: linear-gradient(135deg, #0077b5, #004182); }
    .node-icon.msads { background: linear-gradient(135deg, #00a4ef, #0078d4); }
    .node-icon.datalayer { background: linear-gradient(135deg, #ff9800, #ff5722); }

    /* Brand logo icons - using inline SVG data URIs for reliability */
    .node-icon.has-logo {
      background-size: 70% 70%;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }
    /* GA4 - Analytics chart icon */
    .node-icon.ga4.has-logo { background-color: #fff; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23f9ab00' d='M43 36.6V11.4c0-2.1-1.7-3.9-3.9-3.9H8.9C6.7 7.5 5 9.2 5 11.4v25.2c0 2.1 1.7 3.9 3.9 3.9h30.2c2.2 0 3.9-1.8 3.9-3.9z'/%3E%3Cpath fill='%23fff' d='M36 34H12v-2h24v2zm0-6H12v-2h24v2zm-12-6h12v-2H24v2zm-12 0h8v-2h-8v2z'/%3E%3C/svg%3E"); }
    /* Google Ads */
    .node-icon.gads.has-logo { background-color: #fff; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cellipse cx='24' cy='37' rx='7' ry='7' fill='%2334a853'/%3E%3Cpath fill='%234285f4' d='M41 24L24 4 7 24l7 7 10-13 10 13z'/%3E%3Cpath fill='%23fbbc04' d='M7 24l7-7 10 13-7 7z'/%3E%3C/svg%3E"); }
    /* Meta/Facebook - f icon */
    .node-icon.meta.has-logo { background-color: #0866ff; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' d='M13.397 20.997v-8.196h2.765l.411-3.209h-3.176V7.548c0-.926.258-1.56 1.587-1.56h1.684V3.127A22.336 22.336 0 0 0 14.201 3c-2.444 0-4.122 1.492-4.122 4.231v2.355H7.332v3.209h2.753v8.202h3.312z'/%3E%3C/svg%3E"); background-size: 55% 55%; }
    /* LinkedIn - in icon */
    .node-icon.linkedin.has-logo { background-color: #0077b5; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' d='M6.94 5a2 2 0 1 1-4-.002 2 2 0 0 1 4 .002zM7 8.48H3V21h4V8.48zm6.32 0H9.34V21h3.94v-6.57c0-3.66 4.77-4 4.77 0V21H22v-7.93c0-6.17-7.06-5.94-8.72-2.91l.04-1.68z'/%3E%3C/svg%3E"); background-size: 55% 55%; }
    /* Microsoft - 4 squares */
    .node-icon.msads.has-logo { background-color: #fff; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 23 23'%3E%3Cpath fill='%23f25022' d='M1 1h10v10H1z'/%3E%3Cpath fill='%2300a4ef' d='M1 12h10v10H1z'/%3E%3Cpath fill='%237fba00' d='M12 1h10v10H12z'/%3E%3Cpath fill='%23ffb900' d='M12 12h10v10H12z'/%3E%3C/svg%3E"); background-size: 60% 60%; }
    /* WooCommerce - W icon */
    .node-icon.woo.has-logo { background-color: #7f54b3; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23fff' d='M15 25h12l8 35 10-35h10l10 35 8-35h12L70 75H58L50 45l-8 30H30L15 25z'/%3E%3C/svg%3E"); background-size: 75% 75%; }
    /* Stape.io - S icon */
    .node-icon.stape.has-logo { background-color: #6366f1; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23fff' d='M65 30c0-8-7-15-20-15-15 0-22 8-22 18 0 12 10 16 22 19 8 2 12 4 12 8s-4 8-12 8c-10 0-14-5-14-12H18c0 14 10 24 27 24 16 0 25-9 25-21 0-14-12-17-25-21-7-2-10-4-10-7s4-6 10-6c8 0 11 4 11 10h9z'/%3E%3C/svg%3E"); background-size: 65% 65%; }
    /* Cloudflare - CF shield */
    .node-icon.proxy.has-logo { background-color: #f48120; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23fff' d='M70 35c-2-10-11-17-22-17-9 0-17 5-21 13-9 1-16 9-16 18 0 10 8 18 18 18h40c8 0 15-7 15-15 0-7-5-14-12-16l-2-1z'/%3E%3C/svg%3E"); background-size: 70% 70%; }
    /* Complianz - Shield check */
    .node-icon.complianz.has-logo { background-color: #00a0d2; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' d='M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z'/%3E%3C/svg%3E"); background-size: 60% 60%; }
    /* GTM Web - Tag icon with blue bg */
    .node-icon.wgtm.has-logo { background-color: #4285f4; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z'/%3E%3Cpath fill='%23fff' d='M20.41 4.94l-1.35-1.35c-.78-.78-2.05-.78-2.83 0L4.94 14.88c-.39.39-.39 1.02 0 1.41l1.35 1.35c.39.39 1.02.39 1.41 0L19 6.35c.78-.78.78-2.05 0-2.83l1.41 1.42z' opacity='.5'/%3E%3C/svg%3E"); background-size: 60% 60%; }
    /* GTM Server - Tag icon with green bg */
    .node-icon.sgtm.has-logo { background-color: #34a853; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z'/%3E%3Cpath fill='%23fff' d='M20.41 4.94l-1.35-1.35c-.78-.78-2.05-.78-2.83 0L4.94 14.88c-.39.39-.39 1.02 0 1.41l1.35 1.35c.39.39 1.02.39 1.41 0L19 6.35c.78-.78.78-2.05 0-2.83l1.41 1.42z' opacity='.5'/%3E%3C/svg%3E"); background-size: 60% 60%; }

    /* GTM overlay letters */
    .node-icon.wgtm.has-logo::after { content: 'W'; position: absolute; bottom: 1px; right: 1px; font-size: 11px; font-weight: 800; color: #fff; background: rgba(0,0,0,0.7); border-radius: 3px; padding: 1px 4px; line-height: 1.1; }
    .node-icon.sgtm.has-logo::after { content: 'S'; position: absolute; bottom: 1px; right: 1px; font-size: 11px; font-weight: 800; color: #fff; background: rgba(0,0,0,0.7); border-radius: 3px; padding: 1px 4px; line-height: 1.1; }

    .node-title-group { flex: 1; }

    .node-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 2px;
    }

    .node-subtitle {
      font-size: 11px;
      color: #888;
    }

    .node-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }

    .node-badge.error { background: #f44336; color: #fff; }
    .node-badge.warning { background: #ff9800; color: #000; }
    .node-badge.success { background: #4caf50; color: #fff; }
    .node-badge.notset { background: #607d8b; color: #fff; }
    .node-badge.partial { background: #ff9800; color: #000; }

    .node-body { padding: 12px 15px; }

    .node-section { margin-bottom: 10px; }
    .node-section:last-child { margin-bottom: 0; }

    .node-section-title {
      font-size: 10px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .node-item {
      padding: 6px 8px;
      background: #0f3460;
      border-radius: 5px;
      margin-bottom: 4px;
      font-size: 11px;
      color: #ddd;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .node-item:last-child { margin-bottom: 0; }

    .node-item.error {
      background: rgba(244,67,54,0.15);
      border: 1px solid rgba(244,67,54,0.4);
    }

    .node-item.warning {
      background: rgba(255,152,0,0.15);
      border: 1px solid rgba(255,152,0,0.4);
    }

    .node-item.success {
      background: rgba(76,175,80,0.15);
      border: 1px solid rgba(76,175,80,0.4);
    }

    .node-item-icon {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      flex-shrink: 0;
    }

    .item-icon-success { background: #4caf50; color: #fff; }
    .item-icon-error { background: #f44336; color: #fff; }
    .item-icon-warning { background: #ff9800; color: #fff; }
    .item-icon-gray { background: #607d8b; color: #fff; }

    .node-item-text { flex: 1; }

    .node-item-badge {
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
    }

    /* Enhanced expandable sections */
    .node-expandable-section {
      margin-top: 8px;
      border-top: 1px solid #2d3a5a;
      padding-top: 8px;
    }

    .node-expand-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      background: rgba(45, 58, 90, 0.3);
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 6px;
    }

    .node-expand-header:hover {
      background: rgba(45, 58, 90, 0.6);
    }

    .node-expand-title {
      font-size: 10px;
      font-weight: 600;
      color: #aaa;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .node-expand-icon {
      font-size: 8px;
      color: #666;
      transition: transform 0.2s;
    }

    .node-expand-icon.open {
      transform: rotate(90deg);
    }

    /* Detail rows */
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 4px 8px;
      background: rgba(15, 52, 96, 0.3);
      border-radius: 4px;
      margin-bottom: 3px;
      font-size: 10px;
    }

    .detail-label {
      color: #888;
      flex-shrink: 0;
    }

    .detail-value {
      color: #ddd;
      text-align: right;
      word-break: break-all;
      margin-left: 10px;
    }

    .detail-value.code {
      font-family: 'Consolas', monospace;
      color: #ff9800;
      background: rgba(255, 152, 0, 0.1);
      padding: 1px 4px;
      border-radius: 2px;
    }

    .detail-value.error {
      color: #f44336;
    }

    .detail-value.success {
      color: #4caf50;
    }

    /* Variable pills */
    .variable-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 6px;
      background: rgba(33, 150, 243, 0.15);
      border: 1px solid rgba(33, 150, 243, 0.3);
      border-radius: 4px;
      font-size: 9px;
      color: #64b5f6;
      margin: 2px;
    }

    .variable-pill.warning {
      background: rgba(255, 152, 0, 0.15);
      border-color: rgba(255, 152, 0, 0.3);
      color: #ffb74d;
    }

    /* Action button */
    .action-button {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
      padding: 8px 12px;
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1));
      border: 1px solid rgba(76, 175, 80, 0.4);
      border-radius: 6px;
      color: #4caf50;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .action-button:hover {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.2));
      border-color: rgba(76, 175, 80, 0.6);
    }

    .action-button.critical {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.2), rgba(244, 67, 54, 0.1));
      border-color: rgba(244, 67, 54, 0.4);
      color: #f44336;
    }

    .action-button.critical:hover {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.2));
      border-color: rgba(244, 67, 54, 0.6);
    }

    /* Trigger block - simplified display */
    .trigger-block {
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 6px;
      border-left: 3px solid #666;
    }

    .trigger-block.error {
      background: rgba(244, 67, 54, 0.08);
      border-left-color: #f44336;
    }

    .trigger-block.success {
      background: rgba(76, 175, 80, 0.08);
      border-left-color: #4caf50;
    }

    .trigger-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .trigger-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .trigger-status-dot.error { background: #f44336; }
    .trigger-status-dot.success { background: #4caf50; }

    .trigger-name {
      flex: 1;
      font-size: 11px;
      font-weight: 600;
      color: #ddd;
    }

    .trigger-label {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .trigger-label.wrong {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    .trigger-label.correct {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    /* Regex display */
    .regex-display {
      padding: 6px 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      font-family: 'Consolas', monospace;
      font-size: 9px;
      color: #81c784;
      word-break: break-all;
      line-height: 1.4;
      margin-top: 6px;
    }

    .regex-highlight {
      color: #ff9800;
      font-weight: 600;
    }

    /* Legend */
    .legend {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(22, 33, 62, 0.95);
      border: 1px solid #2d3a5a;
      border-radius: 8px;
      z-index: 100;
      font-size: 11px;
      color: #aaa;
      overflow: hidden;
    }

    .legend-header {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .legend-header:hover {
      background: rgba(45, 58, 90, 0.5);
    }

    .legend-title {
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-toggle {
      font-size: 10px;
      color: #666;
    }

    .legend-body {
      padding: 0 14px 12px 14px;
      border-top: 1px solid #2d3a5a;
    }

    .legend-body.collapsed {
      display: none;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .legend-line {
      width: 30px;
      height: 2px;
    }

    .legend-line.active { background: #4caf50; }
    .legend-line.partial {
      background: repeating-linear-gradient(90deg, #ff9800, #ff9800 8px, transparent 8px, transparent 12px);
    }
    .legend-line.error {
      background: repeating-linear-gradient(90deg, #f44336, #f44336 8px, transparent 8px, transparent 12px);
    }

    /* Selection box styles */
    .react-flow__selection {
      background: rgba(33, 150, 243, 0.1) !important;
      border: 1px dashed #2196f3 !important;
    }

    /* Selected node highlight */
    .react-flow__node.selected .custom-node,
    .custom-node.selected {
      box-shadow: 0 0 0 3px #2196f3, 0 4px 20px rgba(33, 150, 243, 0.4) !important;
    }

    .react-flow__node.selected {
      z-index: 100 !important;
    }

    /* Tooltip container must be highest */
    .react-flow__renderer {
      overflow: visible !important;
    }

    /* Selection hint - auto-hide */
    .selection-hint {
      position: fixed;
      bottom: 60px;
      left: 20px;
      background: rgba(22, 33, 62, 0.95);
      border: 1px solid #2d3a5a;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 11px;
      color: #888;
      z-index: 100;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
    }

    .selection-hint.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .selection-hint kbd {
      background: #2d3a5a;
      padding: 2px 6px;
      border-radius: 3px;
      color: #fff;
      font-family: inherit;
    }

    .selection-hint .dismiss {
      margin-left: 10px;
      cursor: pointer;
      color: #666;
    }

    .selection-hint .dismiss:hover {
      color: #fff;
    }

    /* Edge Tooltip */
    .edge-tooltip {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 8px;
      background: rgba(22, 33, 62, 0.98);
      border: 1px solid #4a6a9a;
      border-radius: 8px;
      padding: 12px 16px;
      min-width: 240px;
      max-width: 320px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      z-index: 99999 !important;
      animation: tooltipFade 0.2s ease;
    }

    .edge-tooltip.has-fix {
      border-color: #f44336;
    }

    /* Ensure edge labels are above nodes */
    .react-flow__edgelabel-renderer {
      z-index: 10000 !important;
    }

    @keyframes tooltipFade {
      from { opacity: 0; transform: translateX(-50%) translateY(-5px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .edge-tooltip-title {
      font-size: 12px;
      font-weight: 700;
      color: #64b5f6;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .edge-tooltip-title::before {
      content: '‚ÑπÔ∏è';
    }

    .edge-tooltip.has-fix .edge-tooltip-title {
      color: #f44336;
    }

    .edge-tooltip.has-fix .edge-tooltip-title::before {
      content: '‚ö†Ô∏è';
    }

    .edge-tooltip-content {
      font-size: 11px;
      color: #ccc;
      line-height: 1.5;
    }

    .edge-tooltip-content:not(:last-child) {
      margin-bottom: 8px;
    }

    .edge-tooltip-fix {
      font-size: 11px;
      color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 4px;
      padding: 6px 8px;
      line-height: 1.4;
      margin-top: 8px;
    }

    .edge-tooltip-fix strong {
      color: #66bb6a;
    }

    /* Nested expandable sections */
    .nested-section {
      margin-top: 6px;
      margin-left: 8px;
      border-left: 2px solid #2d3a5a;
      padding-left: 10px;
    }

    .nested-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      background: rgba(30, 45, 80, 0.4);
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      color: #aaa;
      margin-bottom: 4px;
    }

    .nested-header:hover {
      background: rgba(45, 58, 90, 0.6);
      color: #fff;
    }

    .nested-icon {
      font-size: 8px;
      transition: transform 0.2s;
    }

    .nested-icon.open {
      transform: rotate(90deg);
    }

    .nested-content {
      padding: 6px 0;
    }

    /* Detail cards inside nested sections */
    .detail-card {
      background: rgba(15, 30, 60, 0.5);
      border: 1px solid #2d3a5a;
      border-radius: 6px;
      padding: 8px 10px;
      margin-bottom: 6px;
    }

    .detail-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .detail-card-title {
      font-size: 10px;
      font-weight: 600;
      color: #fff;
    }

    .detail-card-badge {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 8px;
      font-weight: 700;
    }

    .detail-card-rows {
      font-size: 9px;
      color: #aaa;
    }

    .detail-card-row {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
      border-bottom: 1px solid rgba(45, 58, 90, 0.3);
    }

    .detail-card-row:last-child {
      border-bottom: none;
    }

    .detail-card-key {
      color: #888;
    }

    .detail-card-value {
      color: #ddd;
      font-family: 'Consolas', monospace;
    }

    .detail-card-value.error { color: #f44336; }
    .detail-card-value.success { color: #4caf50; }
    .detail-card-value.warning { color: #ff9800; }

    /* Info tooltip on hover */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.2);
      color: #64b5f6;
      font-size: 9px;
      cursor: help;
      margin-left: 4px;
    }

    /* Wider cards for more content */
    .custom-node.expanded-width {
      min-width: 300px;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav-menu">
    <div class="nav-logo">
      <span class="nav-logo-icon">M</span>
      Messer GTM Audit
    </div>
    <div class="nav-links">
      <a href="canvas.html" class="nav-link active">Canvas</a>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
    </div>
    <div class="nav-status">
      <span class="nav-badge critical">1 Critical</span>
      <span class="nav-badge medium">4 Partial</span>
      <span class="nav-badge verified">5 Working</span>
    </div>
  </nav>

  <div id="root"></div>
  <div id="legend-root"></div>
  <div id="selection-hint" class="selection-hint">
    <kbd>Left-drag</kbd> select ¬∑ <kbd>Shift+click</kbd> add ¬∑ <kbd>Right-drag</kbd> pan
    <span class="dismiss" onclick="dismissHint()">‚úï</span>
  </div>
  <script>
    // Show hint briefly on load, then hide
    let hintDismissed = localStorage.getItem('hintDismissed') === 'true';
    if (!hintDismissed) {
      setTimeout(() => document.getElementById('selection-hint').classList.add('visible'), 500);
      setTimeout(() => {
        if (!hintDismissed) document.getElementById('selection-hint').classList.remove('visible');
      }, 5000);
    }
    function dismissHint() {
      document.getElementById('selection-hint').classList.remove('visible');
      localStorage.setItem('hintDismissed', 'true');
      hintDismissed = true;
    }
  </script>

  <script type="text/babel">
    const { useState, useCallback } = React;
    const {
      ReactFlow,
      ReactFlowProvider,
      Controls,
      MiniMap,
      Background,
      useNodesState,
      useEdgesState,
      Handle,
      Position,
      getSmoothStepPath,
      EdgeLabelRenderer,
      BaseEdge
    } = window.ReactFlow;

    // Custom Edge with Tooltip
    function TooltipEdge({ id, sourceX, sourceY, targetX, targetY, sourcePosition, targetPosition, data, style, markerEnd }) {
      const [showTooltip, setShowTooltip] = useState(false);
      const [edgePath, labelX, labelY] = getSmoothStepPath({
        sourceX, sourceY, targetX, targetY,
        sourcePosition, targetPosition,
        borderRadius: 20
      });

      return (
        <>
          <BaseEdge
            id={id}
            path={edgePath}
            style={style}
            markerEnd={markerEnd}
          />
          {/* Invisible wider path for easier hover */}
          <path
            d={edgePath}
            fill="none"
            strokeWidth={20}
            stroke="transparent"
            onMouseEnter={() => setShowTooltip(true)}
            onMouseLeave={() => setShowTooltip(false)}
            style={{ cursor: 'pointer' }}
          />
          <EdgeLabelRenderer>
            <div
              style={{
                position: 'absolute',
                transform: `translate(-50%, -50%) translate(${labelX}px, ${labelY}px)`,
                pointerEvents: 'all',
                zIndex: showTooltip ? 99999 : 1000,
              }}
              onMouseEnter={() => setShowTooltip(true)}
              onMouseLeave={() => setShowTooltip(false)}
            >
              {data?.label && (
                <span style={{
                  background: '#0d1117',
                  padding: '2px 6px',
                  borderRadius: '4px',
                  fontSize: '10px',
                  fontWeight: 600,
                  color: data.labelColor || '#f44336',
                  border: `1px solid ${data.labelColor || '#f44336'}`,
                  cursor: 'pointer'
                }}>
                  {data.label}
                </span>
              )}
              {showTooltip && data?.tooltip && (
                <div className={`edge-tooltip ${data.tooltipFix ? 'has-fix' : ''}`}>
                  <div className="edge-tooltip-title">{data.tooltipTitle || 'Info'}</div>
                  <div className="edge-tooltip-content">{data.tooltip}</div>
                  {data.tooltipFix && (
                    <div className="edge-tooltip-fix">
                      <strong>Fix:</strong> {data.tooltipFix}
                    </div>
                  )}
                </div>
              )}
            </div>
          </EdgeLabelRenderer>
        </>
      );
    }

    const edgeTypes = { tooltip: TooltipEdge };

    // Expandable Section Component
    function ExpandableSection({ title, icon, children, defaultOpen = false }) {
      const [open, setOpen] = useState(defaultOpen);
      return (
        <div className="node-expandable-section">
          <div className="node-expand-header" onClick={() => setOpen(!open)}>
            <span className="node-expand-title">{icon} {title}</span>
            <span className={`node-expand-icon ${open ? 'open' : ''}`}>‚ñ∂</span>
          </div>
          {open && children}
        </div>
      );
    }

    // Nested Section Component (for cards inside cards)
    function NestedSection({ title, children, defaultOpen = false }) {
      const [open, setOpen] = useState(defaultOpen);
      return (
        <div className="nested-section">
          <div className="nested-header" onClick={() => setOpen(!open)}>
            <span className={`nested-icon ${open ? 'open' : ''}`}>‚ñ∂</span>
            <span>{title}</span>
          </div>
          {open && <div className="nested-content">{children}</div>}
        </div>
      );
    }

    // Detail Card Component
    function DetailCard({ title, badge, badgeColor, rows }) {
      return (
        <div className="detail-card">
          <div className="detail-card-header">
            <span className="detail-card-title">{title}</span>
            {badge && <span className="detail-card-badge" style={{ background: badgeColor || '#607d8b', color: '#fff' }}>{badge}</span>}
          </div>
          <div className="detail-card-rows">
            {rows.map((row, idx) => (
              <div className="detail-card-row" key={idx}>
                <span className="detail-card-key">{row.key}</span>
                <span className={`detail-card-value ${row.status || ''}`}>{row.value}</span>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // Custom Node Component with multiple handles for better edge routing
    function CustomNode({ data }) {
      const [expanded, setExpanded] = useState(data.expanded || false);
      const handleStyle = { background: '#4a5a8a', width: 8, height: 8 };

      return (
        <div className={`custom-node ${data.nodeType}`}>
          {/* Target handles - where edges come IN */}
          <Handle type="target" position={Position.Left} id="left" style={handleStyle} />
          <Handle type="target" position={Position.Top} id="top" style={handleStyle} />

          <div className="node-header" onClick={() => setExpanded(!expanded)}>
            <div className={`node-icon ${data.nodeType} ${data.useLogo ? 'has-logo' : ''}`}>{data.useLogo ? '' : data.icon}</div>
            <div className="node-title-group">
              <div className="node-title">{data.label}</div>
              <div className="node-subtitle">{data.subtitle}</div>
            </div>
            <span className={`node-badge ${data.status}`}>{data.statusText}</span>
          </div>

          {expanded && (
            <div className="node-body">
              {/* Standard items */}
              {data.items && data.items.map((section, idx) => (
                <div className="node-section" key={idx}>
                  <div className="node-section-title">{section.title}</div>
                  {section.rows.map((row, ridx) => (
                    <div className={`node-item ${row.type || ''}`} key={ridx}>
                      <span className={`node-item-icon item-icon-${row.iconType || 'gray'}`}>
                        {row.iconType === 'success' ? '\u2713' : row.iconType === 'error' ? 'X' : row.iconType === 'warning' ? '!' : '?'}
                      </span>
                      <span className="node-item-text">{row.text}</span>
                      {row.badge && (
                        <span className="node-item-badge" style={{background: row.badgeColor, color: '#fff'}}>{row.badge}</span>
                      )}
                    </div>
                  ))}
                </div>
              ))}

              {/* Trigger Details - Simplified */}
              {data.triggers && (
                <ExpandableSection title="Trigger Config" icon="‚ö°" defaultOpen={data.triggersOpen}>
                  {data.triggers.map((trigger, idx) => (
                    <div key={idx} className={`trigger-block ${trigger.status}`}>
                      <div className="trigger-header">
                        <span className={`trigger-status-dot ${trigger.status}`}></span>
                        <span className="trigger-name">{trigger.name}</span>
                        {trigger.status === 'error' && <span className="trigger-label wrong">CURRENT</span>}
                        {trigger.status === 'success' && <span className="trigger-label correct">USE THIS</span>}
                      </div>
                      {trigger.regex && (
                        <div className="regex-display">{trigger.regex}</div>
                      )}
                    </div>
                  ))}
                </ExpandableSection>
              )}

              {/* Variables */}
              {data.variables && (
                <ExpandableSection title="Variables" icon="üì¶">
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: 2}}>
                    {data.variables.map((v, idx) => (
                      <span key={idx} className={`variable-pill ${v.warning ? 'warning' : ''}`}>
                        {v.name}
                      </span>
                    ))}
                  </div>
                  {/* Nested variable details */}
                  {data.variableDetails && (
                    <NestedSection title="Variable Mappings" defaultOpen={false}>
                      {data.variableDetails.map((detail, idx) => (
                        <DetailCard key={idx} title={detail.name} badge={detail.badge} badgeColor={detail.badgeColor} rows={detail.rows} />
                      ))}
                    </NestedSection>
                  )}
                </ExpandableSection>
              )}

              {/* Detailed Config Sections */}
              {data.configSections && data.configSections.map((section, idx) => (
                <ExpandableSection key={idx} title={section.title} icon={section.icon} defaultOpen={section.defaultOpen}>
                  {section.items && section.items.map((item, iidx) => (
                    <div key={iidx} className={`node-item ${item.type || ''}`}>
                      <span className={`node-item-icon item-icon-${item.iconType || 'gray'}`}>
                        {item.iconType === 'success' ? '‚úì' : item.iconType === 'error' ? 'X' : item.iconType === 'warning' ? '!' : '?'}
                      </span>
                      <span className="node-item-text">{item.text}</span>
                    </div>
                  ))}
                  {section.nestedSections && section.nestedSections.map((nested, nidx) => (
                    <NestedSection key={nidx} title={nested.title} defaultOpen={nested.defaultOpen}>
                      {nested.cards && nested.cards.map((card, cidx) => (
                        <DetailCard key={cidx} title={card.title} badge={card.badge} badgeColor={card.badgeColor} rows={card.rows} />
                      ))}
                      {nested.text && <div style={{fontSize: '10px', color: '#aaa', padding: '4px 0'}}>{nested.text}</div>}
                    </NestedSection>
                  ))}
                </ExpandableSection>
              ))}

              {/* Action Required */}
              {data.action && (
                <div
                  className={`action-button ${data.action.critical ? 'critical' : ''}`}
                  onClick={(e) => { e.stopPropagation(); if(data.action.onClick) data.action.onClick(); }}
                >
                  <span>{data.action.critical ? 'üîß' : '‚úì'}</span>
                  <span>{data.action.text}</span>
                </div>
              )}

              {/* Recommendation Comparison */}
              {data.recommendation && (
                <div style={{ marginTop: '12px' }}>
                  <div className="recommendation-box current">
                    <div className="recommendation-box-title">‚ö†Ô∏è {data.recommendation.current.title}</div>
                    <ul className="recommendation-list">
                      {data.recommendation.current.items.map((item, idx) => (
                        <li key={idx}>{item}</li>
                      ))}
                    </ul>
                  </div>
                  <div className="recommendation-box recommended" style={{ marginTop: '8px' }}>
                    <div className="recommendation-box-title">‚úÖ {data.recommendation.recommended.title}</div>
                    <ul className="recommendation-list">
                      {data.recommendation.recommended.items.map((item, idx) => (
                        <li key={idx}>{item}</li>
                      ))}
                    </ul>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Source handles - where edges go OUT */}
          <Handle type="source" position={Position.Right} id="right" style={handleStyle} />
          <Handle type="source" position={Position.Bottom} id="bottom" style={handleStyle} />
        </div>
      );
    }

    const nodeTypes = { custom: CustomNode };

    // Nodes - Layout designed for clarity with ALL cards expanded
    // Column 1 (x:50): Sources | Column 2 (x:350): DataLayer | Column 3 (x:600): wGTM Hub | Column 4 (x:1050+): Server Path | Row 3 (y:1100): Destinations
    const initialNodes = [
      // Row 1: Sources (left column, stacked vertically) - both push to DataLayer
      {
        id: 'woo',
        type: 'custom',
        position: { x: 50, y: 50 },
        data: {
          label: 'WooCommerce',
          subtitle: 'DataLayer Source',
          icon: 'W',
          nodeType: 'woo',
          useLogo: true,
          status: 'success',
          statusText: 'OK',
          expanded: true,
          items: [
            {
              title: 'Events Pushed',
              rows: [
                { text: 'view_item, add_to_cart', iconType: 'success', type: 'success' },
                { text: 'begin_checkout, purchase', iconType: 'success', type: 'success' },
                { text: 'view_item_list, select_item', iconType: 'success', type: 'success' }
              ]
            },
            {
              title: 'Minor Issues',
              rows: [
                { text: 'Legacy checkout event', iconType: 'warning', type: 'warning' },
                { text: 'Guest UUID as user_id', iconType: 'warning', type: 'warning' }
              ]
            }
          ],
          variables: [
            { name: 'ecommerce.items' },
            { name: 'ecommerce.value' },
            { name: 'ecommerce.currency' },
            { name: 'user_id', warning: true },
            { name: 'transaction_id' }
          ],
          variableDetails: [
            {
              name: 'user_id Issue',
              badge: 'WARNING',
              badgeColor: '#ff9800',
              rows: [
                { key: 'Current', value: 'Guest UUID', status: 'warning' },
                { key: 'Problem', value: 'Changes per session' },
                { key: 'Fix', value: 'Only send for logged-in users', status: 'success' }
              ]
            }
          ],
          configSections: [
            {
              title: 'Event Details',
              icon: 'üìä',
              defaultOpen: false,
              nestedSections: [
                {
                  title: 'view_item (5 events)',
                  defaultOpen: false,
                  cards: [
                    { title: 'Data Format', rows: [{ key: 'Format', value: 'GA4', status: 'success' }, { key: 'items[]', value: 'Present' }, { key: 'value', value: 'Present' }] }
                  ]
                },
                {
                  title: 'add_to_cart (2 events)',
                  defaultOpen: false,
                  cards: [
                    { title: 'Data Format', rows: [{ key: 'Format', value: 'GA4', status: 'success' }, { key: 'items[]', value: 'Present' }, { key: 'value', value: 'Present' }] }
                  ]
                },
                {
                  title: 'checkout Issue',
                  defaultOpen: false,
                  cards: [
                    { title: 'Dual Event Push', badge: 'WARNING', badgeColor: '#ff9800', rows: [{ key: 'checkout', value: 'Legacy UA format', status: 'warning' }, { key: 'begin_checkout', value: 'GA4 format', status: 'success' }, { key: 'Action', value: 'Remove legacy checkout event' }] }
                  ]
                }
              ]
            }
          ]
        }
      },
      {
        id: 'complianz',
        type: 'custom',
        position: { x: 50, y: 520 },
        data: {
          label: 'Complianz',
          subtitle: 'Consent Mode v2',
          icon: 'C',
          nodeType: 'complianz',
          useLogo: true,
          status: 'success',
          statusText: 'OK',
          expanded: true,
          items: [{ title: 'Consent Signals', rows: [
            { text: 'consent_update events firing', iconType: 'success', type: 'success' },
            { text: 'GCM v2 compliance', iconType: 'success', type: 'success' }
          ] }],
          configSections: [
            {
              title: 'Consent Categories',
              icon: 'üîí',
              defaultOpen: false,
              nestedSections: [
                {
                  title: 'Consent States',
                  defaultOpen: false,
                  cards: [
                    { title: 'Marketing', rows: [{ key: 'ad_storage', value: 'granted', status: 'success' }, { key: 'ad_user_data', value: 'granted', status: 'success' }, { key: 'ad_personalization', value: 'granted', status: 'success' }] },
                    { title: 'Analytics', rows: [{ key: 'analytics_storage', value: 'granted', status: 'success' }] }
                  ]
                }
              ]
            }
          ]
        }
      },
      // DataLayer - central collection point (both WooCommerce and Complianz push here)
      {
        id: 'datalayer',
        type: 'custom',
        position: { x: 420, y: 250 },
        data: {
          label: 'DataLayer',
          subtitle: 'window.dataLayer[]',
          icon: '[]',
          nodeType: 'wgtm',
          status: 'success',
          statusText: 'HUB',
          expanded: true,
          items: [
            {
              title: 'Receives Events From',
              rows: [
                { text: 'WooCommerce: ecommerce events', iconType: 'success', type: 'success' },
                { text: 'Complianz: consent_update', iconType: 'success', type: 'success' }
              ]
            }
          ],
          configSections: [
            {
              title: 'Event Queue',
              icon: 'üìã',
              defaultOpen: false,
              nestedSections: [
                {
                  title: 'Ecommerce Events',
                  defaultOpen: false,
                  cards: [
                    { title: 'Observed', rows: [{ key: 'view_item', value: '5 events' }, { key: 'add_to_cart', value: '2 events' }, { key: 'begin_checkout', value: '2 events' }, { key: 'view_cart', value: '1 event' }] }
                  ]
                },
                {
                  title: 'Consent Events',
                  defaultOpen: false,
                  cards: [
                    { title: 'GCM v2', rows: [{ key: 'consent_default', value: 'On page load' }, { key: 'consent_update', value: 'After user choice' }] }
                  ]
                }
              ]
            }
          ]
        }
      },
      // Row 2: wGTM Hub (reads from DataLayer, fires tags based on consent)
      {
        id: 'wgtm',
        type: 'custom',
        position: { x: 750, y: 50 },
        data: {
          label: 'wGTM',
          subtitle: 'GTM-MNRP4PF',
          icon: 'G',
          nodeType: 'wgtm',
          useLogo: true,
          status: 'error',
          statusText: 'ISSUE',
          expanded: true,
          items: [
            {
              title: 'üî¥ SERVER-SIDE TAGS (via /metrics)',
              rows: [
                { text: 'Google Tag (GT-NS9Z5FWG)', iconType: 'success', type: 'success', badge: '524 msgs', badgeColor: '#4caf50' },
                { text: '‚Üí /metrics ‚Üí sGTM (working)', iconType: 'success', type: 'success' },
                { text: 'Data Tag #310 (Stape)', iconType: 'error', type: 'error', badge: 'BROKEN', badgeColor: '#f44336' },
                { text: '‚Üí /metrics/data ‚Üí sGTM (purchase only!)', iconType: 'error', type: 'error' }
              ]
            },
            {
              title: 'üü¢ CLIENT-SIDE TAGS (direct to platforms)',
              rows: [
                { text: 'FB - Page View (Pixel)', iconType: 'success', type: 'success', badge: '13x', badgeColor: '#607d8b' },
                { text: 'MS UET base + events', iconType: 'success', type: 'success', badge: '22x', badgeColor: '#607d8b' },
                { text: 'LinkedIn Insight', iconType: 'success', type: 'success', badge: '12x', badgeColor: '#607d8b' },
                { text: 'Google Ads (calls)', iconType: 'success', type: 'success', badge: '26x', badgeColor: '#607d8b' },
                { text: 'Conversion Linker', iconType: 'success', type: 'success', badge: '13x', badgeColor: '#607d8b' }
              ]
            }
          ],
          triggersOpen: true,
          triggers: [
            {
              name: 'ce_purchase (Trigger #96) - CURRENT',
              status: 'error',
              regex: 'Data Tag uses this ‚Üí purchase ONLY'
            },
            {
              name: 'Ecom Core Events (Trigger #313) - USE THIS',
              status: 'success',
              regex: 'page_view|view_item|add_to_cart|begin_checkout|purchase|...'
            }
          ],
          variables: [
            { name: 'Customers Email' },
            { name: 'Customers Phone' },
            { name: 'External ID' },
            { name: 'Event Id' },
            { name: 'dlv_transactionID' },
            { name: 'dlv_value' },
            { name: 'dlv - user_id', warning: true }
          ],
          action: {
            critical: true,
            text: 'Change trigger 96 ‚Üí 313 on Data Tag'
          },
          // Recommendation comparison section
          recommendation: {
            current: {
              title: 'Current Setup (Broken)',
              items: [
                '1 Data Tag ‚Üí purchase only',
                'Trigger #96 = ce_purchase',
                '~95% events lost'
              ]
            },
            recommended: {
              title: 'Recommended (Enterprise)',
              items: [
                '4 Data Tags by category',
                'Core + Ecommerce + Conversion + Engagement',
                '100% events to sGTM'
              ]
            }
          }
        }
      },
      // Row 3: Server-side path (right columns)
      {
        id: 'proxy',
        type: 'custom',
        position: { x: 1200, y: 50 },
        data: {
          label: 'CF Worker',
          subtitle: '/metrics/* proxy',
          icon: 'CF',
          nodeType: 'proxy',
          useLogo: true,
          status: 'success',
          statusText: 'OK',
          items: [{ title: 'Verified', rows: [{ text: 'Cache bypass, WAF exempt', iconType: 'success', type: 'success' }] }]
        }
      },
      // Stape.io Hosting Platform (contains sGTM)
      {
        id: 'stape',
        type: 'custom',
        position: { x: 1550, y: 50 },
        data: {
          label: 'Stape.io',
          subtitle: 'sGTM Hosting Platform',
          icon: 'ST',
          nodeType: 'stape',
          useLogo: true,
          status: 'success',
          statusText: 'OK',
          expanded: true,
          items: [
            {
              title: 'Platform Status',
              rows: [
                { text: 'Hosting Active', iconType: 'success', type: 'success' },
                { text: 'Custom Domain: metrics.messerattach.com', iconType: 'success', type: 'success' }
              ]
            }
          ],
          configSections: [
            {
              title: 'Stape Add-ons',
              icon: 'üß©',
              defaultOpen: true,
              items: [
                { text: 'Data Tag/Client (wGTM‚ÜîsGTM)', iconType: 'success', type: 'success' },
                { text: 'User Data Enrichment', iconType: 'success', type: 'success' },
                { text: 'Event Deduplication', iconType: 'success', type: 'success' }
              ],
              nestedSections: [
                {
                  title: 'Data Tag Config',
                  defaultOpen: false,
                  cards: [
                    { title: 'wGTM Data Tag #310', badge: 'ISSUE', badgeColor: '#f44336', rows: [{ key: 'Trigger', value: '96 (purchase only)', status: 'error' }, { key: 'Should be', value: '313 (all events)', status: 'success' }] },
                    { title: 'sGTM Data Client', rows: [{ key: 'Status', value: 'Ready', status: 'success' }, { key: 'Receives', value: 'Events from Data Tag' }] }
                  ]
                },
                {
                  title: 'User Enrichment',
                  defaultOpen: false,
                  cards: [
                    { title: 'PII Hashing', rows: [{ key: 'Email', value: 'SHA256', status: 'success' }, { key: 'Phone', value: 'SHA256', status: 'success' }] }
                  ]
                }
              ]
            }
          ],
          variables: [
            { name: 'x-stape-*' },
            { name: 'event_id' },
            { name: 'user_data' }
          ]
        }
      },
      {
        id: 'sgtm',
        type: 'custom',
        position: { x: 1550, y: 520 },
        data: {
          label: 'sGTM Container',
          subtitle: 'GTM-K3CQBMZ9 (on Stape)',
          icon: 'S',
          nodeType: 'sgtm',
          useLogo: true,
          status: 'warning',
          statusText: 'PARTIAL',
          expanded: true,
          items: [
            {
              title: 'CLIENTS (Ingestion Points)',
              rows: [
                { text: 'Data Client #18 ‚Üí /data', iconType: 'success', type: 'success', badge: 'P:102', badgeColor: '#2196f3' },
                { text: 'GTM Web Container #69', iconType: 'success', type: 'success', badge: 'default', badgeColor: '#607d8b' }
              ]
            },
            {
              title: 'Data Flow Issue',
              rows: [
                { text: 'Data Client: purchase only (trigger 96)', iconType: 'error', type: 'error' },
                { text: 'GTM Web: gtag events (524 msgs)', iconType: 'success', type: 'success' },
                { text: 'sGTM Tag Assistant: 0 messages!', iconType: 'error', type: 'error' }
              ]
            }
          ],
          configSections: [
            {
              title: 'Server-Side Tags',
              icon: 'üè∑Ô∏è',
              defaultOpen: false,
              nestedSections: [
                {
                  title: 'GA4 Server Tag',
                  defaultOpen: false,
                  cards: [
                    { title: 'Configuration', rows: [{ key: 'Measurement ID', value: 'G-YCL5FGZNCV' }, { key: 'Fires on', value: 'All incoming events', status: 'success' }] }
                  ]
                },
                {
                  title: 'Meta CAPI Tag',
                  defaultOpen: false,
                  cards: [
                    { title: 'Configuration', rows: [{ key: 'Pixel ID', value: 'Configured' }, { key: 'Dedup', value: 'event_id', status: 'success' }] }
                  ]
                },
                {
                  title: 'Google Ads Tag',
                  defaultOpen: false,
                  cards: [
                    { title: 'Configuration', rows: [{ key: 'Conv ID', value: 'AW-767740215' }, { key: 'Enhanced Conv', value: 'Enabled', status: 'success' }] }
                  ]
                },
                {
                  title: 'LinkedIn CAPI Tag',
                  defaultOpen: false,
                  cards: [
                    { title: 'Configuration', rows: [{ key: 'Partner ID', value: '4898740' }] }
                  ]
                }
              ]
            }
          ],
          triggers: [
            {
              name: 'Stape Data Tag Client',
              status: 'success',
              regex: 'Receives all events from wGTM Data Tag'
            }
          ],
          variables: [
            { name: 'event_name' },
            { name: 'user_data.*' },
            { name: 'ecommerce.*' },
            { name: 'x-stape-*' }
          ],
          action: {
            critical: false,
            text: 'No changes needed (fix wGTM first)'
          },
          recommendation: {
            current: {
              title: 'Current Issue',
              items: [
                'Data Client receives purchase only',
                '0 events in sGTM Tag Assistant',
                'Platform tags starving for data'
              ]
            },
            recommended: {
              title: 'After wGTM Fix',
              items: [
                'All events flow to Data Client',
                'All sGTM tags fire correctly',
                'Full funnel attribution'
              ]
            }
          }
        }
      },
      // Bottom row - All destinations (y:1200 for clearance from expanded nodes)
      {
        id: 'ga4',
        type: 'custom',
        position: { x: 50, y: 1200 },
        data: {
          label: 'GA4',
          subtitle: 'G-YCL5FGZNCV',
          icon: 'üìä',
          nodeType: 'ga4',
          useLogo: true,
          status: 'warning',
          statusText: 'PARTIAL',
          items: [
            { title: 'Client-Side (Working)', rows: [
              { text: 'All ecom events via gTag', iconType: 'success', type: 'success' }
            ]},
            { title: 'Server-Side (Partial)', rows: [
              { text: 'purchase only', iconType: 'warning', type: 'warning' }
            ]},
            { title: 'Missing Server Events', rows: [
              { text: 'view_item, add_to_cart', iconType: 'error', type: 'error' },
              { text: 'begin_checkout, view_cart', iconType: 'error', type: 'error' }
            ]}
          ],
          triggers: [
            {
              name: 'GA4 Tag in sGTM',
              status: 'success',
              regex: 'Fires on all incoming events'
            }
          ],
          action: {
            critical: false,
            text: 'Will auto-fix when wGTM trigger updated'
          }
        }
      },
      {
        id: 'gads',
        type: 'custom',
        position: { x: 420, y: 1200 },
        data: {
          label: 'Google Ads',
          subtitle: 'AW-767740215',
          icon: 'üìà',
          nodeType: 'gads',
          useLogo: true,
          status: 'warning',
          statusText: 'PARTIAL',
          items: [
            { title: 'Client-Side (Working)', rows: [
              { text: 'Conversions via gTag', iconType: 'success', type: 'success' },
              { text: 'Call tracking enabled', iconType: 'success', type: 'success' }
            ]},
            { title: 'Server-Side (Partial)', rows: [
              { text: 'Purchase conversion only', iconType: 'warning', type: 'warning' }
            ]},
            { title: 'Missing Micro-Conversions', rows: [
              { text: 'Add to cart, view item', iconType: 'error', type: 'error' }
            ]}
          ],
          triggers: [
            {
              name: 'Google Tag (Trigger #330)',
              status: 'success',
              regex: 'All Pages - after consent'
            }
          ],
          action: {
            critical: false,
            text: 'Auto-fixes when wGTM updated'
          }
        }
      },
      {
        id: 'meta',
        type: 'custom',
        position: { x: 790, y: 1200 },
        data: {
          label: 'Meta',
          subtitle: 'FB Pixel + CAPI',
          icon: 'üìò',
          nodeType: 'meta',
          useLogo: true,
          status: 'warning',
          statusText: 'PARTIAL',
          items: [
            { title: 'FB Pixel (Client)', rows: [
              { text: 'All events via Pixel template', iconType: 'success', type: 'success' }
            ]},
            { title: 'CAPI (Server)', rows: [
              { text: 'Purchase only', iconType: 'warning', type: 'warning' }
            ]},
            { title: 'Missing CAPI Events', rows: [
              { text: 'ViewContent, AddToCart', iconType: 'error', type: 'error' },
              { text: 'InitiateCheckout', iconType: 'error', type: 'error' }
            ]}
          ],
          variables: [
            { name: 'fbp (1st party)' },
            { name: 'fbc (click ID)' },
            { name: 'external_id' },
            { name: 'Event Id (dedup)' }
          ],
          action: {
            critical: false,
            text: 'CAPI auto-fixes when wGTM updated'
          }
        }
      },
      {
        id: 'linkedin',
        type: 'custom',
        position: { x: 1160, y: 1200 },
        data: {
          label: 'LinkedIn',
          subtitle: 'Partner ID: 4898740',
          icon: 'üíº',
          nodeType: 'linkedin',
          useLogo: true,
          status: 'warning',
          statusText: 'PARTIAL',
          items: [
            { title: 'Insight Tag (Client)', rows: [
              { text: 'Page views tracked', iconType: 'success', type: 'success' }
            ]},
            { title: 'CAPI (Server)', rows: [
              { text: 'Purchase conversion only', iconType: 'warning', type: 'warning' }
            ]},
            { title: 'Missing CAPI Events', rows: [
              { text: 'Page views, Add to cart', iconType: 'error', type: 'error' }
            ]}
          ],
          triggers: [
            {
              name: 'All Pages (Trigger #330)',
              status: 'success',
              regex: 'After Complianz consent granted'
            }
          ],
          action: {
            critical: false,
            text: 'CAPI auto-fixes when wGTM updated'
          }
        }
      },
      {
        id: 'msads',
        type: 'custom',
        position: { x: 1530, y: 1200 },
        data: {
          label: 'MS Ads',
          subtitle: 'UET: 343101821',
          icon: 'MS',
          nodeType: 'msads',
          useLogo: true,
          status: 'success',
          statusText: 'OK',
          items: [
            { title: 'UET Base Tag', rows: [
              { text: 'Page views tracked', iconType: 'success', type: 'success' },
              { text: 'Enhanced conversions ON', iconType: 'success', type: 'success' }
            ]},
            { title: 'UET Purchase Tag', rows: [
              { text: 'Purchase conversions', iconType: 'success', type: 'success' }
            ]},
            { title: 'Server-Side', rows: [
              { text: 'Not available for MS Ads', iconType: 'gray' }
            ]}
          ],
          triggers: [
            {
              name: 'All Pages (Built-in)',
              status: 'success',
              regex: 'GTM initialization trigger'
            }
          ],
          variables: [
            { name: 'Customers Email' },
            { name: 'Customers Phone' }
          ]
        }
      }
    ];

    // Edges with specific handles to prevent overlap
    const initialEdges = [
      // SOURCES ‚Üí DATALAYER (both push events independently)
      {
        id: 'e1a',
        source: 'woo',
        target: 'datalayer',
        sourceHandle: 'right',
        targetHandle: 'left',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'ecommerce.*',
          labelColor: '#96588a',
          tooltipTitle: 'WooCommerce ‚Üí DataLayer',
          tooltip: 'WooCommerce pushes GA4 ecommerce events: view_item (5x), add_to_cart (2x), begin_checkout (2x), view_cart (1x). All events include items[], value, and currency.',
          tooltipFix: null
        },
        style: { stroke: '#96588a', strokeWidth: 2 }
      },
      {
        id: 'e1b',
        source: 'complianz',
        target: 'datalayer',
        sourceHandle: 'right',
        targetHandle: 'left',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'consent_update',
          labelColor: '#00a0d2',
          tooltipTitle: 'Complianz ‚Üí DataLayer',
          tooltip: 'Complianz pushes Google Consent Mode v2 events. Includes consent_default on page load and consent_update after user choice. Categories: ad_storage, ad_user_data, ad_personalization, analytics_storage.',
          tooltipFix: null
        },
        style: { stroke: '#00a0d2', strokeWidth: 2 }
      },

      // DATALAYER ‚Üí wGTM (GTM reads from DataLayer)
      {
        id: 'e2',
        source: 'datalayer',
        target: 'wgtm',
        sourceHandle: 'right',
        targetHandle: 'left',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'GTM Reads',
          labelColor: '#ff9800',
          tooltipTitle: 'DataLayer ‚Üí wGTM',
          tooltip: 'GTM continuously monitors window.dataLayer[] for new events. Triggers fire based on event names matching configured conditions. Variables extract data from the dataLayer for use in tags.',
          tooltipFix: null
        },
        style: { stroke: '#ff9800', strokeWidth: 2 }
      },

      // CLIENT-SIDE: wGTM Tags ‚Üí Destinations (fires after consent granted)
      {
        id: 'e3',
        source: 'wgtm',
        target: 'ga4',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'gTag (CS)',
          labelColor: '#4caf50',
          tooltipTitle: 'Google Tag ‚Üí GA4 (Client-Side)',
          tooltip: 'Google Tag (GT-NS9Z5FWG) sends events directly to GA4. Configured with server_container_url for hybrid routing. All ecommerce events flow through this tag. 524 messages observed.',
          tooltipFix: null
        },
        style: { stroke: '#4caf50', strokeWidth: 2 }
      },
      {
        id: 'e4',
        source: 'wgtm',
        target: 'gads',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'CS',
          labelColor: '#4caf50',
          tooltipTitle: 'Google Ads Tags (Client-Side)',
          tooltip: 'Two call tracking tags: google_ads_calls and google_ads_800calls. Both fire on All Pages (13x each). Conversion ID: AW-767740215. Labels: ZLAFCNKDkusY, WrSjCJnAiesY.',
          tooltipFix: null
        },
        style: { stroke: '#4caf50', strokeWidth: 2 }
      },
      {
        id: 'e5',
        source: 'wgtm',
        target: 'meta',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'Pixel (CS)',
          labelColor: '#4caf50',
          tooltipTitle: 'FB Pixel (Client-Side)',
          tooltip: 'FB - Page View tag fires on All Pages (13x). Pixel ID: 3695834564032094. Sends PageView and ecommerce events directly to Facebook. Works alongside server-side CAPI for deduplication.',
          tooltipFix: null
        },
        style: { stroke: '#4caf50', strokeWidth: 2 }
      },
      {
        id: 'e6',
        source: 'wgtm',
        target: 'linkedin',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'Insight (CS)',
          labelColor: '#4caf50',
          tooltipTitle: 'LinkedIn Insight Tag (Client-Side)',
          tooltip: 'LinkedIn Insight tag fires on All Pages (12x). Partner ID: 4898740. Tracks page views for LinkedIn audience building and conversion attribution.',
          tooltipFix: null
        },
        style: { stroke: '#4caf50', strokeWidth: 2 }
      },
      {
        id: 'e7',
        source: 'wgtm',
        target: 'msads',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'UET (CS)',
          labelColor: '#4caf50',
          tooltipTitle: 'Microsoft UET Tags (Client-Side)',
          tooltip: 'Multiple UET tags: ms_uet_base (13x), ms_uet_view_item (5x), ms_uet_add_to_cart (2x), ms_uet_checkout (2x). UET Tag ID: 343101821. Enhanced conversions enabled with email/phone hashing.',
          tooltipFix: null
        },
        style: { stroke: '#4caf50', strokeWidth: 2 }
      },

      // SERVER-SIDE PATH 1: Google Tag (gtag) ‚Üí /metrics ‚Üí sGTM - WORKING
      {
        id: 'e8a',
        source: 'wgtm',
        target: 'proxy',
        sourceHandle: 'right',
        targetHandle: 'left',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'gtag /metrics ‚úì',
          labelColor: '#4caf50',
          tooltipTitle: 'Google Tag Server Routing (Working)',
          tooltip: 'Google Tag (GT-NS9Z5FWG) routes via server_container_url: https://messerattach.com/metrics. 524 messages sent successfully. This path IS working correctly.',
          tooltipFix: null
        },
        style: { stroke: '#4caf50', strokeWidth: 2 }
      },
      // SERVER-SIDE PATH 2: Data Tag ‚Üí /metrics/data ‚Üí sGTM - BROKEN
      {
        id: 'e8b',
        source: 'wgtm',
        target: 'proxy',
        sourceHandle: 'right',
        targetHandle: 'left',
        type: 'tooltip',
        data: {
          label: 'Data Tag ‚ö†Ô∏è',
          labelColor: '#f44336',
          tooltipTitle: 'Data Tag #310 Trigger Issue',
          tooltip: 'The Stape Data Tag uses trigger 96 (ce_purchase) which only fires on purchase events. Events like view_item, add_to_cart, begin_checkout, and view_cart are NOT being sent to sGTM via /metrics/data.',
          tooltipFix: 'Change Data Tag trigger from 96 (ce_purchase) to 313 (Trigger - Ecom Core Events) to send ALL ecommerce events.'
        },
        style: { stroke: '#f44336', strokeWidth: 2, strokeDasharray: '8 4' }
      },
      // CF Worker ‚Üí Stape.io (proxy passes requests to Stape endpoint)
      {
        id: 'e9a',
        source: 'proxy',
        target: 'stape',
        sourceHandle: 'right',
        targetHandle: 'left',
        type: 'tooltip',
        animated: true,
        data: {
          label: '/data + /metrics',
          labelColor: '#ff9800',
          tooltipTitle: 'CF Worker ‚Üí Stape.io',
          tooltip: 'Cloudflare Worker rewrites /metrics/* ‚Üí /* and forwards to sgtm.messerattach.com. Two paths: /data (Data Tag - purchase only) and / (gtag - all events). Worker verified working correctly.',
          tooltipFix: null
        },
        style: { stroke: '#ff9800', strokeWidth: 2 }
      },
      // Stape.io ‚Üí sGTM (Stape hosts sGTM container)
      {
        id: 'e9b',
        source: 'stape',
        target: 'sgtm',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        animated: true,
        data: {
          label: 'hosts',
          labelColor: '#00bcd4',
          tooltipTitle: 'Stape.io Hosts sGTM',
          tooltip: 'Stape.io provides the hosting infrastructure for sGTM container GTM-K3CQBMZ9. Includes add-ons: Data Tag/Client for wGTM‚ÜîsGTM communication, User Data Enrichment, and Event Deduplication.',
          tooltipFix: null
        },
        style: { stroke: '#00bcd4', strokeWidth: 2 }
      },

      // Server-side: sGTM ‚Üí destinations (single label showing limited flow)
      {
        id: 'e10',
        source: 'sgtm',
        target: 'ga4',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        data: {
          label: 'SS',
          labelColor: '#ff9800',
          tooltipTitle: 'GA4 Server-Side (Partial)',
          tooltip: 'GA4 receives server-side purchase events only. Missing: view_item, add_to_cart, begin_checkout, view_cart.',
          tooltipFix: 'Fix wGTM Data Tag trigger to enable full server-side tracking.'
        },
        style: { stroke: '#ff9800', strokeWidth: 2, strokeDasharray: '8 4' }
      },
      {
        id: 'e11',
        source: 'sgtm',
        target: 'gads',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        data: {
          label: 'SS',
          labelColor: '#ff9800',
          tooltipTitle: 'Google Ads Server-Side (Partial)',
          tooltip: 'Google Ads receives server-side purchase conversions only. Missing micro-conversions.',
          tooltipFix: 'Enable all events to improve conversion tracking.'
        },
        style: { stroke: '#ff9800', strokeWidth: 2, strokeDasharray: '8 4' }
      },
      {
        id: 'e12',
        source: 'sgtm',
        target: 'meta',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        data: {
          label: 'CAPI',
          labelColor: '#ff9800',
          tooltipTitle: 'Meta CAPI (Partial)',
          tooltip: 'Meta CAPI only receives purchase. Missing ViewContent, AddToCart, InitiateCheckout.',
          tooltipFix: 'Full event flow improves Meta ad delivery and ROAS.'
        },
        style: { stroke: '#ff9800', strokeWidth: 2, strokeDasharray: '8 4' }
      },
      {
        id: 'e13',
        source: 'sgtm',
        target: 'linkedin',
        sourceHandle: 'bottom',
        targetHandle: 'top',
        type: 'tooltip',
        data: {
          label: 'CAPI',
          labelColor: '#ff9800',
          tooltipTitle: 'LinkedIn CAPI (Partial)',
          tooltip: 'LinkedIn CAPI only receives purchase conversions. Missing page views.',
          tooltipFix: 'Enable all events for better attribution.'
        },
        style: { stroke: '#ff9800', strokeWidth: 2, strokeDasharray: '8 4' }
      }
      // Note: No server-side path to MS Ads (no CAPI available)
    ];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TARGET STATE - Enterprise Architecture (Recommended Configuration)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const targetNodes = [
      // Row 1: Data Sources (same as current)
      {
        id: 'woo',
        type: 'custom',
        position: { x: 50, y: 150 },
        data: {
          label: 'WooCommerce',
          subtitle: 'Ecommerce Events',
          icon: 'W',
          nodeType: 'woo',
          useLogo: true,
          status: 'success',
          statusText: 'OK',
          expanded: true,
          items: [{ title: 'Events', rows: [
            { text: 'view_item (5x)', iconType: 'success', type: 'success' },
            { text: 'add_to_cart (2x)', iconType: 'success', type: 'success' },
            { text: 'begin_checkout (2x)', iconType: 'success', type: 'success' },
            { text: 'purchase (1x)', iconType: 'success', type: 'success' }
          ] }]
        }
      },
      {
        id: 'complianz',
        type: 'custom',
        position: { x: 50, y: 450 },
        data: {
          label: 'Complianz',
          subtitle: 'Consent Mode v2',
          icon: 'C',
          nodeType: 'complianz',
          useLogo: true,
          status: 'success',
          statusText: 'OK',
          items: [{ title: 'Consent Signals', rows: [
            { text: 'consent_default ‚Üí page load', iconType: 'success', type: 'success' },
            { text: 'consent_update ‚Üí user choice', iconType: 'success', type: 'success' }
          ] }]
        }
      },
      // DataLayer
      {
        id: 'datalayer',
        type: 'custom',
        position: { x: 350, y: 250 },
        data: {
          label: 'DataLayer',
          subtitle: 'window.dataLayer[]',
          icon: '[]',
          nodeType: 'datalayer',
          status: 'success',
          statusText: 'OK',
          items: [{ title: 'Event Types', rows: [
            { text: 'GA4 Ecommerce events', iconType: 'success', type: 'success' },
            { text: 'Consent Mode events', iconType: 'success', type: 'success' },
            { text: 'Custom events', iconType: 'success', type: 'success' }
          ] }]
        }
      },
      // wGTM - TARGET STATE with multiple Data Tags
      {
        id: 'wgtm',
        type: 'custom',
        position: { x: 700, y: 50 },
        data: {
          label: 'wGTM',
          subtitle: 'GTM-MNRP4PF',
          icon: 'G',
          nodeType: 'wgtm',
          useLogo: true,
          status: 'success',
          statusText: 'FIXED',
          expanded: true,
          items: [
            {
              title: '‚úÖ DATA TAGS (Enterprise Setup)',
              rows: [
                { text: 'Core Events Tag ‚Üí page_view, scroll', iconType: 'success', type: 'success', badge: 'NEW', badgeColor: '#4caf50' },
                { text: 'Ecommerce Tag ‚Üí view_item, add_to_cart...', iconType: 'success', type: 'success', badge: 'NEW', badgeColor: '#4caf50' },
                { text: 'Conversion Tag ‚Üí purchase, refund', iconType: 'success', type: 'success', badge: 'NEW', badgeColor: '#4caf50' },
                { text: 'Engagement Tag ‚Üí form_submit, search', iconType: 'success', type: 'success', badge: 'NEW', badgeColor: '#4caf50' }
              ]
            },
            {
              title: '‚úÖ CLIENT-SIDE TAGS (Fallback)',
              rows: [
                { text: 'FB Pixel (dedup with CAPI)', iconType: 'success', type: 'success' },
                { text: 'MS UET (no CAPI available)', iconType: 'success', type: 'success' },
                { text: 'LinkedIn Insight', iconType: 'success', type: 'success' },
                { text: 'Google Ads (enhanced conv)', iconType: 'success', type: 'success' }
              ]
            }
          ],
          triggersOpen: true,
          triggers: [
            { name: 'TR - Page View', status: 'success', regex: 'All Pages' },
            { name: 'TR - Ecommerce All', status: 'success', regex: 'view_item|add_to_cart|begin_checkout|...' },
            { name: 'TR - Purchase', status: 'success', regex: 'purchase' },
            { name: 'TR - Engagement', status: 'success', regex: 'form_submit|search|scroll' }
          ],
          variables: [
            { name: 'CJS - Client ID' },
            { name: 'CJS - Session ID' },
            { name: 'CJS - Event ID (dedup)' },
            { name: 'DLV - ecommerce.items' },
            { name: 'DLV - ecommerce.value' },
            { name: 'DLV - transaction_id' }
          ]
        }
      },
      // CF Worker (same)
      {
        id: 'proxy',
        type: 'custom',
        position: { x: 1150, y: 50 },
        data: {
          label: 'CF Worker',
          subtitle: '/gtm/* proxy',
          icon: 'CF',
          nodeType: 'proxy',
          useLogo: true,
          status: 'success',
          statusText: 'OK',
          items: [{ title: 'Routes', rows: [
            { text: '/gtm/metrics ‚Üí gtag.js', iconType: 'success', type: 'success' },
            { text: '/gtm/data ‚Üí Data Tags', iconType: 'success', type: 'success' }
          ] }]
        }
      },
      // Stape Platform
      {
        id: 'stape',
        type: 'custom',
        position: { x: 1500, y: 200 },
        data: {
          label: 'Stape.io',
          subtitle: 'sGTM Hosting',
          icon: 'S',
          nodeType: 'stape',
          useLogo: true,
          status: 'success',
          statusText: 'OK',
          items: [{ title: 'Infrastructure', rows: [
            { text: 'EU region hosting', iconType: 'success', type: 'success' },
            { text: 'Auto-scaling enabled', iconType: 'success', type: 'success' }
          ] }]
        }
      },
      // sGTM - TARGET STATE
      {
        id: 'sgtm',
        type: 'custom',
        position: { x: 1500, y: 450 },
        data: {
          label: 'sGTM Container',
          subtitle: 'GTM-K3CQBMZ9',
          icon: 'S',
          nodeType: 'sgtm',
          useLogo: true,
          status: 'success',
          statusText: 'FIXED',
          expanded: true,
          items: [
            {
              title: '‚úÖ CLIENTS (All Events)',
              rows: [
                { text: 'GA4 Client ‚Üí gtag.js requests', iconType: 'success', type: 'success' },
                { text: 'Data Client ‚Üí all Data Tag events', iconType: 'success', type: 'success', badge: 'FIXED', badgeColor: '#4caf50' }
              ]
            },
            {
              title: '‚úÖ SERVER-SIDE TAGS',
              rows: [
                { text: 'GA4 ‚Üí all events forwarded', iconType: 'success', type: 'success' },
                { text: 'Meta CAPI ‚Üí all ecommerce', iconType: 'success', type: 'success' },
                { text: 'Google Ads ‚Üí purchases + enhanced', iconType: 'success', type: 'success' },
                { text: 'LinkedIn CAPI ‚Üí all conversions', iconType: 'success', type: 'success' }
              ]
            }
          ],
          triggers: [
            { name: 'TR - All Events', status: 'success', regex: 'Client Name = Data Client' },
            { name: 'TR - Ecommerce', status: 'success', regex: 'view_item|add_to_cart|purchase' },
            { name: 'TR - Purchase Only', status: 'success', regex: 'event_name = purchase' }
          ]
        }
      },
      // Destination Platforms - Row 4
      {
        id: 'ga4',
        type: 'custom',
        position: { x: 1900, y: 100 },
        data: {
          label: 'Google Analytics 4',
          subtitle: 'G-YCL5FGZNCV',
          icon: 'GA',
          nodeType: 'ga4',
          useLogo: true,
          status: 'success',
          statusText: 'ALL EVENTS',
          items: [{ title: 'Receiving', rows: [
            { text: 'All page views', iconType: 'success', type: 'success' },
            { text: 'All ecommerce events', iconType: 'success', type: 'success' },
            { text: 'All conversions', iconType: 'success', type: 'success' }
          ] }]
        }
      },
      {
        id: 'gads',
        type: 'custom',
        position: { x: 1900, y: 300 },
        data: {
          label: 'Google Ads',
          subtitle: 'AW-767740215',
          icon: 'G',
          nodeType: 'gads',
          useLogo: true,
          status: 'success',
          statusText: 'ALL EVENTS',
          items: [{ title: 'Conversions', rows: [
            { text: 'Purchase (enhanced)', iconType: 'success', type: 'success' },
            { text: 'Add to cart', iconType: 'success', type: 'success' },
            { text: 'Page view', iconType: 'success', type: 'success' }
          ] }]
        }
      },
      {
        id: 'meta',
        type: 'custom',
        position: { x: 1900, y: 500 },
        data: {
          label: 'Meta (CAPI)',
          subtitle: 'Server-Side',
          icon: 'M',
          nodeType: 'meta',
          useLogo: true,
          status: 'success',
          statusText: 'ALL EVENTS',
          items: [{ title: 'Events', rows: [
            { text: 'PageView', iconType: 'success', type: 'success' },
            { text: 'ViewContent', iconType: 'success', type: 'success' },
            { text: 'AddToCart', iconType: 'success', type: 'success' },
            { text: 'Purchase (deduped)', iconType: 'success', type: 'success' }
          ] }]
        }
      },
      {
        id: 'linkedin',
        type: 'custom',
        position: { x: 1900, y: 700 },
        data: {
          label: 'LinkedIn (CAPI)',
          subtitle: 'Server-Side',
          icon: 'in',
          nodeType: 'linkedin',
          useLogo: true,
          status: 'success',
          statusText: 'ALL EVENTS',
          items: [{ title: 'Conversions', rows: [
            { text: 'Page views', iconType: 'success', type: 'success' },
            { text: 'Purchases', iconType: 'success', type: 'success' }
          ] }]
        }
      },
      {
        id: 'msads',
        type: 'custom',
        position: { x: 1900, y: 880 },
        data: {
          label: 'Microsoft Ads',
          subtitle: 'UET (Client-Side)',
          icon: 'M',
          nodeType: 'msads',
          useLogo: true,
          status: 'warning',
          statusText: 'NO CAPI',
          items: [{ title: 'Note', rows: [
            { text: 'MS UET has no CAPI option', iconType: 'info', type: 'info' },
            { text: 'Client-side only (fallback)', iconType: 'warning', type: 'warning' }
          ] }]
        }
      }
    ];

    const targetEdges = [
      // DataLayer inputs
      { id: 't-e1a', source: 'woo', target: 'datalayer', type: 'tooltip', animated: true,
        data: { label: 'ecommerce.*', labelColor: '#96588a', tooltipTitle: 'WooCommerce Events', tooltip: 'All GA4 ecommerce events flowing correctly.' },
        style: { stroke: '#96588a', strokeWidth: 2 } },
      { id: 't-e1b', source: 'complianz', target: 'datalayer', type: 'tooltip', animated: true,
        data: { label: 'consent', labelColor: '#00a0d2', tooltipTitle: 'Consent Mode', tooltip: 'GCM v2 compliant consent signals.' },
        style: { stroke: '#00a0d2', strokeWidth: 2 } },
      // DataLayer to wGTM
      { id: 't-e2', source: 'datalayer', target: 'wgtm', type: 'tooltip', animated: true,
        data: { label: 'All Events', labelColor: '#4caf50', tooltipTitle: 'Full Event Stream', tooltip: 'wGTM receives ALL events from DataLayer.' },
        style: { stroke: '#4caf50', strokeWidth: 3 } },
      // wGTM to CF Worker (multiple Data Tags)
      { id: 't-e8', source: 'wgtm', target: 'proxy', type: 'tooltip', animated: true,
        data: { label: '4 Data Tags', labelColor: '#4caf50', tooltipTitle: 'Enterprise Data Tags', tooltip: 'Core + Ecommerce + Conversion + Engagement tags all firing.' },
        style: { stroke: '#4caf50', strokeWidth: 3 } },
      // CF Worker to Stape
      { id: 't-e9a', source: 'proxy', target: 'stape', type: 'tooltip', animated: true,
        data: { label: '/gtm/*', labelColor: '#4caf50', tooltipTitle: 'First-Party Proxy', tooltip: 'All requests proxied through first-party domain.' },
        style: { stroke: '#4caf50', strokeWidth: 2 } },
      // Stape to sGTM
      { id: 't-e9b', source: 'stape', target: 'sgtm', type: 'tooltip', animated: true,
        data: { label: 'hosts', labelColor: '#4caf50', tooltipTitle: 'Container Hosting', tooltip: 'sGTM container receiving all events.' },
        style: { stroke: '#4caf50', strokeWidth: 2 } },
      // sGTM to destinations (all working)
      { id: 't-e10', source: 'sgtm', target: 'ga4', type: 'tooltip', animated: true,
        data: { label: 'All Events', labelColor: '#4caf50', tooltipTitle: 'GA4 Server Tag', tooltip: 'All events forwarded to GA4.' },
        style: { stroke: '#4caf50', strokeWidth: 2 } },
      { id: 't-e11', source: 'sgtm', target: 'gads', type: 'tooltip', animated: true,
        data: { label: 'Conversions', labelColor: '#4caf50', tooltipTitle: 'Google Ads Tag', tooltip: 'Enhanced conversions with user data.' },
        style: { stroke: '#4caf50', strokeWidth: 2 } },
      { id: 't-e12', source: 'sgtm', target: 'meta', type: 'tooltip', animated: true,
        data: { label: 'CAPI', labelColor: '#4caf50', tooltipTitle: 'Meta CAPI', tooltip: 'All ecommerce events with deduplication.' },
        style: { stroke: '#4caf50', strokeWidth: 2 } },
      { id: 't-e13', source: 'sgtm', target: 'linkedin', type: 'tooltip', animated: true,
        data: { label: 'CAPI', labelColor: '#4caf50', tooltipTitle: 'LinkedIn CAPI', tooltip: 'All conversion events.' },
        style: { stroke: '#4caf50', strokeWidth: 2 } },
      // Client-side fallback for MS Ads
      { id: 't-e14', source: 'wgtm', target: 'msads', type: 'tooltip',
        data: { label: 'Client-Side', labelColor: '#ff9800', tooltipTitle: 'UET Fallback', tooltip: 'MS Ads has no CAPI - client-side only.' },
        style: { stroke: '#ff9800', strokeWidth: 2, strokeDasharray: '5 5' } }
    ];

    // Toolbar Component
    function Toolbar({ tool, setTool, viewMode, setViewMode }) {
      // Keyboard shortcuts
      React.useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          if (e.key === 'v' || e.key === 'V') setTool('select');
          if (e.key === 'h' || e.key === 'H') setTool('hand');
          if (e.key === '1') setViewMode('current');
          if (e.key === '2') setViewMode('target');
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [setTool, setViewMode]);

      return (
        <div className="toolbar">
          <button
            className={`toolbar-btn ${tool === 'select' ? 'active' : ''}`}
            onClick={() => setTool('select')}
            title="Select tool"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z" />
              <path d="M13 13l6 6" />
            </svg>
            <span className="toolbar-hint">Select <kbd>V</kbd></span>
          </button>
          <button
            className={`toolbar-btn ${tool === 'hand' ? 'active' : ''}`}
            onClick={() => setTool('hand')}
            title="Hand tool"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0" />
              <path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2" />
              <path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8" />
              <path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15" />
            </svg>
            <span className="toolbar-hint">Hand <kbd>H</kbd></span>
          </button>
          <div className="toolbar-divider"></div>
          <button
            className="toolbar-btn"
            onClick={() => window.reactFlowInstance?.fitView({ padding: 0.3 })}
            title="Fit view"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
            </svg>
            <span className="toolbar-hint">Fit View</span>
          </button>
          <div className="toolbar-divider"></div>
          <button
            className={`toolbar-btn ${viewMode === 'current' ? 'active' : ''}`}
            onClick={() => setViewMode('current')}
            title="Current State"
            style={{ fontSize: '10px', fontWeight: '700' }}
          >
            <span style={{ color: viewMode === 'current' ? '#fff' : '#f44336' }}>!</span>
            <span className="toolbar-hint">Current State <kbd>1</kbd></span>
          </button>
          <button
            className={`toolbar-btn ${viewMode === 'target' ? 'active' : ''}`}
            onClick={() => setViewMode('target')}
            title="Target State"
            style={{ fontSize: '10px', fontWeight: '700', background: viewMode === 'target' ? '#4caf50' : 'transparent' }}
          >
            <span style={{ color: viewMode === 'target' ? '#fff' : '#4caf50' }}>T</span>
            <span className="toolbar-hint">Target State <kbd>2</kbd></span>
          </button>
        </div>
      );
    }

    function Flow() {
      const [viewMode, setViewMode] = useState('current'); // 'current' or 'target'
      const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
      const [edges, setEdges, onEdgesChange] = useEdgesState(initialEdges);
      const [showMinimap, setShowMinimap] = useState(false);
      const [tool, setTool] = useState('select'); // 'select' or 'hand'

      // Switch nodes/edges when viewMode changes
      React.useEffect(() => {
        if (viewMode === 'current') {
          setNodes(initialNodes);
          setEdges(initialEdges);
        } else {
          setNodes(targetNodes);
          setEdges(targetEdges);
        }
        // Fit view after switching
        setTimeout(() => {
          window.reactFlowInstance?.fitView({ padding: 0.3 });
        }, 100);
      }, [viewMode, setNodes, setEdges]);

      // Store instance for fit view button
      const onInit = useCallback((instance) => {
        window.reactFlowInstance = instance;
      }, []);

      // Tool-based settings
      const isHandTool = tool === 'hand';

      return (
        <>
          <Toolbar tool={tool} setTool={setTool} viewMode={viewMode} setViewMode={setViewMode} />
          {/* View Mode Indicator */}
          <div className={`view-mode-indicator ${viewMode}`}>
            {viewMode === 'current' ? '‚ö†Ô∏è Current State (Issues)' : '‚úÖ Target State (Fixed)'}
          </div>
          <div className="flow-container" style={{ cursor: isHandTool ? 'grab' : 'default' }}>
            <ReactFlow
              nodes={nodes}
              edges={edges}
              onNodesChange={onNodesChange}
              onEdgesChange={onEdgesChange}
              onInit={onInit}
              nodeTypes={nodeTypes}
              edgeTypes={edgeTypes}
              fitView
              fitViewOptions={{ padding: 0.3, minZoom: 0.3, maxZoom: 0.8 }}
              minZoom={0.2}
              maxZoom={2}
              defaultViewport={{ x: 0, y: 0, zoom: 0.5 }}
              defaultEdgeOptions={{ type: 'smoothstep', pathOptions: { borderRadius: 20 } }}
              selectionOnDrag={!isHandTool}
              selectNodesOnDrag={!isHandTool}
              selectionMode="partial"
              panOnDrag={isHandTool ? [0, 1, 2] : [1, 2]}
              selectionKeyCode={isHandTool ? null : null}
            multiSelectionKeyCode="Shift"
            deleteKeyCode={null}
          >
            <Controls />
            {showMinimap && (
              <MiniMap
                nodeColor={(n) => n.data?.status === 'error' ? '#f44336' : '#4caf50'}
                maskColor="rgba(0,0,0,0.8)"
              />
            )}
            <Background color="#2d3a5a" gap={50} />
          </ReactFlow>
          <button
            className="minimap-toggle"
            onClick={() => setShowMinimap(!showMinimap)}
          >
            {showMinimap ? '‚ñº Hide Map' : '‚ñ≤ Show Map'}
          </button>
        </div>
        </>
      );
    }

    function App() {
      return (
        <ReactFlowProvider>
          <Flow />
        </ReactFlowProvider>
      );
    }

    // Legend Component
    function Legend() {
      const [expanded, setExpanded] = useState(false);

      return (
        <div className="legend">
          <div className="legend-header" onClick={() => setExpanded(!expanded)}>
            <span className="legend-title">Connection Status</span>
            <span className="legend-toggle">{expanded ? '‚ñ≤' : '‚ñº'}</span>
          </div>
          <div className={`legend-body ${expanded ? '' : 'collapsed'}`}>
            <div className="legend-item">
              <div className="legend-line active"></div>
              <span>Working (All Events)</span>
            </div>
            <div className="legend-item">
              <div className="legend-line partial"></div>
              <span>Partial (Purchase Only)</span>
            </div>
            <div className="legend-item">
              <div className="legend-line error"></div>
              <span>Missing (view_item, etc.)</span>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    const legendRoot = ReactDOM.createRoot(document.getElementById('legend-root'));
    legendRoot.render(<Legend />);
  </script>
</body>
</html>
