<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GTM Analyzer — Layered View</title>
    <style>
      :root {
        --bg: #0b0f14;
        --panel: #121821;
        --panel-2: #0f141c;
        --muted: #9fb0c3;
        --text: #e6eef8;
        --accent: #7cc0ff;
        --accent-2: #72f0c4;
        --danger: #ff6b6b;
        --warn: #ffd166;
        --ok: #8be38b;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      html, body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }
      .app {
        display: grid;
        grid-template-columns: 320px 1fr 380px;
        grid-template-rows: 56px 1fr;
        grid-template-areas:
          "header header header"
          "sidebar main inspector";
        height: 100%;
      }
      header {
        grid-area: header;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 14px;
        background: linear-gradient(180deg, #111827, #0d131c);
        border-bottom: 1px solid #1b2636;
      }
      header .title {
        font-weight: 650;
        letter-spacing: 0.2px;
      }
      header .meta {
        color: var(--muted);
        font-size: 12px;
      }
      .sidebar {
        grid-area: sidebar;
        border-right: 1px solid #1b2636;
        background: var(--panel);
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .sidebar .section {
        padding: 10px 12px;
        border-bottom: 1px solid #1b2636;
      }
      .sidebar h3 {
        margin: 6px 0 8px;
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .sidebar .container-select {
        display: grid;
        gap: 8px;
      }
      .sidebar select, .sidebar input[type="text"] {
        width: 100%;
        background: #0d131b;
        color: var(--text);
        border: 1px solid #243140;
        border-radius: 8px;
        padding: 8px 10px;
      }
      .layer-list {
        display: grid;
        gap: 6px;
      }
      .layer-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--panel-2);
        border: 1px solid #182333;
        padding: 8px 10px;
        border-radius: 8px;
      }
      .layer-item input { accent-color: var(--accent); }
      .layer-item .badge {
        margin-left: auto;
        font-size: 11px;
        color: var(--muted);
        background: #0b1118;
        border: 1px solid #1b2636;
        border-radius: 6px;
        padding: 2px 6px;
      }

      .main {
        grid-area: main;
        background: var(--bg);
        display: grid;
        grid-template-rows: auto 1fr;
        min-height: 0;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        padding: 10px 12px;
        border-bottom: 1px solid #1b2636;
        background: var(--panel);
      }
      .toolbar .pill {
        border: 1px solid #243140;
        background: #0f1520;
        color: var(--text);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
      }
      .toolbar .pill.active { border-color: var(--accent); color: var(--accent); }

      .content {
        overflow: auto;
        padding: 12px;
      }
      .grid-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 10px;
      }
      .card {
        background: var(--panel-2);
        border: 1px solid #182333;
        border-radius: 10px;
        padding: 10px;
        display: grid;
        gap: 8px;
      }
      .card .title {
        font-weight: 600;
      }
      .kv {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 6px 10px;
        align-items: start;
        font-size: 12px;
      }
      .kv .k { color: var(--muted); }
      .kv .v { color: var(--text); font-family: var(--mono); }

      .inspector {
        grid-area: inspector;
        border-left: 1px solid #1b2636;
        background: var(--panel);
        display: grid;
        grid-template-rows: auto 1fr;
        min-height: 0;
      }
      .inspector .head {
        padding: 10px 12px;
        border-bottom: 1px solid #1b2636;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .inspector .body { overflow: auto; padding: 10px; }
      .json {
        font-family: var(--mono);
        font-size: 12px;
        line-height: 1.45;
        white-space: pre-wrap;
        background: #0d131b;
        border: 1px solid #243140;
        border-radius: 8px;
        padding: 10px;
      }
      .muted { color: var(--muted); }
      .row { display:flex; gap:8px; align-items:center; }
      .grow { flex: 1 1 auto; }
      .ok { color: var(--ok); }
      .warn { color: var(--warn); }
      .danger { color: var(--danger); }
      .pill-sm { font-size: 11px; padding: 2px 6px; border-radius: 999px; border:1px solid #243140; background:#0f1520; }
      .link { color: var(--accent); cursor: pointer; text-decoration: underline; }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .table th, .table td {
        border-bottom: 1px solid #1b2636;
        padding: 8px 6px;
        text-align: left;
      }
      .table th { color: var(--muted); font-weight: 600; }
      .table tr:hover { background: #0f1520; }
      .nowrap { white-space: nowrap; }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div class="title">GTM Analyzer</div>
        <div class="meta" id="meta">Loading…</div>
      </header>

      <aside class="sidebar">
        <div class="section">
          <h3>Container</h3>
          <div class="container-select">
            <select id="containerSelect"></select>
            <input id="search" type="text" placeholder="Search name/id/type…" />
          </div>
        </div>
        <div class="section">
          <h3>Layers</h3>
          <div class="layer-list" id="layerList"></div>
        </div>
      </aside>

      <main class="main">
        <div class="toolbar" id="toolbar">
          <div class="pill active" data-view="overview">Overview</div>
          <div class="pill" data-view="list">List</div>
          <div class="pill" data-view="events">Events</div>
          <div class="pill" data-view="graph">Graph</div>
        </div>
        <div class="content" id="content"></div>
      </main>

      <aside class="inspector">
        <div class="head">
          <div class="row">
            <div id="inspectTitle" class="title">Inspector</div>
            <span id="inspectType" class="pill-sm muted"></span>
          </div>
          <div class="row">
            <span id="inspectStatus" class="pill-sm"></span>
          </div>
        </div>
        <div class="body">
          <div id="inspectBody" class="json">Select an item from the list.</div>
        </div>
      </aside>
    </div>

    <script>
      const FILES = [
        { path: 'GTM-MNRP4PF_workspace247.json', label: 'WEB — GTM-MNRP4PF' },
        { path: 'GTM-K3CQBMZ9_workspace36.json', label: 'SERVER — GTM-K3CQBMZ9' },
      ];

      const LAYERS = [
        { key: 'tags', label: 'Tags' },
        { key: 'triggers', label: 'Triggers' },
        { key: 'variables', label: 'Variables' },
        { key: 'folders', label: 'Folders' },
        { key: 'templates', label: 'Templates' },
        { key: 'builtInVariable', label: 'Built-in Vars' },
        { key: 'clients', label: 'Clients (Server)' },
        { key: 'transformations', label: 'Transformations' },
        { key: 'zones', label: 'Zones' },
        { key: 'consent', label: 'Consent' },
      ];

      const state = {
        containers: {},
        currentKey: null,
        view: 'overview',
        activeLayers: new Set(['tags','triggers','variables','folders','templates','builtInVariable','clients','consent']),
        search: ''
      };

      function byId(id){ return document.getElementById(id); }
      function el(tag, cls, text){ const e=document.createElement(tag); if(cls) e.className=cls; if(text!==undefined) e.textContent=text; return e; }
      function clear(node){ node.innerHTML=''; return node; }
      function fmt(v){ if(v===undefined||v===null) return ''; if(typeof v==='object') return JSON.stringify(v); return String(v); }

      function classifyTag(tag){
        const t = tag.type || '';
        const name = (tag.name||'').toLowerCase();
        // Simple vendor heuristics
        if(t.startsWith('ga')) return 'Google Analytics';
        if(t.includes('ads')||name.includes('google ads')) return 'Google Ads';
        if(t==='bzi'||name.includes('linkedin')) return 'LinkedIn Insight';
        if(name.includes('facebook')||t.includes('fb')||name.includes('meta')) return 'Meta Pixel';
        if(t==='html') return 'Custom HTML';
        if(t.startsWith('cvt_')) return 'Custom Template';
        if(t.includes('gtag')) return 'gtag';
        if(t.includes('consent')) return 'Consent';
        return t;
      }

      function getParam(tag, key){
        const p = tag.parameter||[];
        const it = p.find(x=>x.key===key);
        return it? (it.value||'') : '';
      }
      function getListParams(tag, key){
        const p = tag.parameter||[];
        const it = p.find(x=>x.key===key && Array.isArray(x.list));
        return it? it.list: [];
      }
      function deriveDestinations(tag){
        const v = classifyTag(tag);
        const out = [];
        if(v==='Google Analytics'){
          const id = getParam(tag,'measurementId') || getParam(tag,'trackingId') || 'GA';
          const overrides = getListParams(tag,'parametersToOverride').map(m=>{
            const name=(m.map||[]).find(x=>x.key==='name')?.value; const value=(m.map||[]).find(x=>x.key==='value')?.value; return {name,value};
          });
          out.push({ vendor: 'Google Analytics', id, label: `GA4 ${id}`, payload:{ overrides } });
        } else if(v==='Google Ads'){
          const cid = getParam(tag,'conversionId') || 'AW-?';
          const lbl = getParam(tag,'conversionLabel');
          const value = getParam(tag,'conversionValue');
          const currency = getParam(tag,'currencyCode');
          out.push({ vendor: 'Google Ads', id: cid, label: lbl? `${cid}/${lbl}`: cid, payload:{ value, currency } });
        } else if(v==='LinkedIn Insight'){
          const id = getParam(tag,'id') || 'LI-?';
          out.push({ vendor: 'LinkedIn Insight', id, label: `LI ${id}`, payload:{} });
        } else if(v==='Meta Pixel'){
          const id = getParam(tag,'pixelId') || 'FB-?';
          const eventName = getParam(tag,'standardEventName') || getParam(tag,'eventName') || 'event';
          out.push({ vendor: 'Meta Pixel', id, label: `FB ${id}`, payload:{ eventName } });
        } else if(v==='Custom HTML' || v==='Custom Template'){
          out.push({ vendor: v, id: v, label: v });
        }
        return out;
      }

      function getParam(tag, key){
        const p = tag.parameter||[];
        const it = p.find(x=>x.key===key);
        return it? (it.value||'') : '';
      }

      function deriveDestinations(tag){
        const v = classifyTag(tag);
        const out = [];
        if(v==='Google Analytics'){
          const id = getParam(tag,'measurementId') || getParam(tag,'trackingId') || 'GA';
          out.push({ vendor: 'Google Analytics', id, label: `GA4 ${id}` });
        } else if(v==='Google Ads'){
          function renderGraph(cv){
          const lbl = getParam(tag,'conversionLabel');
            const controls = el('div','row');
            controls.style.margin='6px 0 10px';
            const search = el('input'); search.placeholder='Filter triggers…'; search.style.flex='1'; search.style.background='#0d131b'; search.style.color='var(--text)'; search.style.border='1px solid #243140'; search.style.borderRadius='8px'; search.style.padding='6px 8px';
            const vendorsWrap = el('div','row'); vendorsWrap.style.flexWrap='wrap'; vendorsWrap.style.gap='6px'; vendorsWrap.style.marginLeft='8px';
            controls.appendChild(search); controls.appendChild(vendorsWrap); content.appendChild(controls);

            const wrapper = el('div'); wrapper.style.border='1px solid #1b2636'; wrapper.style.borderRadius='10px'; wrapper.style.height='70vh'; wrapper.style.background='#0d131b'; wrapper.style.position='relative'; content.appendChild(wrapper);

            const triggers = (cv.trigger||[]).map(t=>({ id: t.triggerId, name: t.name||('Trigger '+t.triggerId), type: t.type, raw: t }));
            const tagsRaw = (cv.tag||[]);
            const tags = tagsRaw.map(t=>({ id: t.tagId, name: t.name||('Tag '+t.tagId), type: t.type, vendor: classifyTag(t), firing: new Set(t.firingTriggerId||[]), dests: deriveDestinations(t), raw: t }));
            const vendorSet = Array.from(new Set(tags.map(t=>t.vendor))).filter(Boolean);
            const vendorState = new Map(vendorSet.map(v=>[v,true]));
            vendorSet.forEach(v=>{ const lab=el('label','pill-sm'); const cb=el('input'); cb.type='checkbox'; cb.checked=true; cb.style.marginRight='6px'; cb.onchange=()=>{ vendorState.set(v, cb.checked); draw(); }; lab.appendChild(cb); lab.appendChild(document.createTextNode(v)); vendorsWrap.appendChild(lab); });
            search.oninput = ()=> draw();
        return out;
      }
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%'); svg.style.position='absolute'; svg.style.top='0'; svg.style.left='0'; wrapper.appendChild(svg);
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g'); svg.appendChild(g);

            let scale=1, tx=0, ty=0; function updateTransform(){ g.setAttribute('transform',`translate(${tx},${ty}) scale(${scale})`);} updateTransform();
            let dragging=false, sx=0, sy=0, stx=0, sty=0; wrapper.addEventListener('pointerdown', (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; stx=tx; sty=ty; wrapper.setPointerCapture(e.pointerId); });
            wrapper.addEventListener('pointermove', (e)=>{ if(!dragging) return; tx = stx + (e.clientX - sx); ty = sty + (e.clientY - sy); updateTransform(); });
            wrapper.addEventListener('pointerup', ()=> dragging=false);
            wrapper.addEventListener('wheel', (e)=>{ e.preventDefault(); const ds=e.deltaY<0?1.1:0.9; scale=Math.min(3,Math.max(0.3,scale*ds)); updateTransform(); }, {passive:false});
            const json = await res.json();
        });
        select.value = state.currentKey || '';
        select.onchange = ()=>{ state.currentKey = select.value; render(); };

        const layerList = byId('layerList');
        clear(layerList);
        LAYERS.forEach(layer=>{
          const row = el('label', 'layer-item');
          const cb = el('input'); cb.type='checkbox'; cb.checked = state.activeLayers.has(layer.key);
          cb.onchange = ()=>{ if(cb.checked) state.activeLayers.add(layer.key); else state.activeLayers.delete(layer.key); render(); };
          row.appendChild(cb);

            const pad = 20, colW = 320, gap = 80;
            function node(x,y,w,h, label, sub, fill, onClick){
          p.onclick = ()=>{
            toolbar.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
            p.classList.add('active');
            state.view = p.dataset.view;
            render();
          };
        });

        render();
      }

      function getCV(){
        if(!state.currentKey) return null;
        const c = state.containers[state.currentKey];
        return c?.cv || null;
      }

      function render(){
        const cv = getCV();
        if(!cv){ byId('content').textContent = 'No data.'; return; }

        // Update layer counts
        const counts = {
          tags: cv.tag?.length||0,
          triggers: cv.trigger?.length||0,
          variables: cv.variable?.length||0,
          folders: cv.folder?.length||0,

            function draw(){
              while(g.firstChild) g.removeChild(g.firstChild);
              const leftX = pad; const midX = 360; const rightX = 720;
              const trigQ = search.value.trim().toLowerCase();
              const trigList = triggers.filter(t=> !trigQ || (t.name||'').toLowerCase().includes(trigQ));
              const tY = new Map(); trigList.forEach((t,i)=> tY.set(t.id, i*gap));
              const filteredTags = tags.filter(t=> vendorState.get(t.vendor));
              byTrigger.clear(); trigList.forEach(t=>byTrigger.set(t.id, []));
              filteredTags.forEach(tg=> tg.firing.forEach(trid=>{ if(byTrigger.has(trid)) byTrigger.get(trid).push(tg); }));

              const destMap = new Map();
              filteredTags.forEach(tg=> tg.dests.forEach(d=>{ const key=d.vendor+':'+d.id; if(!destMap.has(key)) destMap.set(key,{key,label:d.label,vendor:d.vendor}); }));
              const destList = Array.from(destMap.values()); const destY=new Map(); destList.forEach((d,i)=> destY.set(d.key,i*gap));

              trigList.forEach(tr=>{ const y=(tY.get(tr.id)||0)+pad; node(leftX,y,260,46,tr.name,tr.type,'#72f0c4',()=>inspect({_kind:'trigger',id:tr.id,name:tr.name,type:tr.type,raw:tr.raw})); });
              filteredTags.forEach((tg,i)=>{ const first=[...tg.firing][0]; const base=(first&&tY.has(first))?tY.get(first):(i*gap); const y=(base||0)+pad; node(midX,y,320,46,tg.name,tg.vendor,color(tg.vendor),()=>inspect({_kind:'tag',id:tg.id,name:tg.name,type:tg.type,raw:tg.raw})); });
              destList.forEach(d=>{ const y=(destY.get(d.key)||0)+pad; node(rightX,y,300,46,d.label,d.vendor,color(d.vendor),()=>inspect({_kind:'destination',id:d.key,name:d.label,type:d.vendor,raw:d})); });
              trigList.forEach(tr=>{ const y1=(tY.get(tr.id)||0)+pad+23; const list=(byTrigger.get(tr.id)||[]); list.forEach(tg=>{ const first=[...tg.firing][0]; const base=(first&&tY.has(first))?tY.get(first):(0); const y2=(base||0)+pad+23; edge(leftX+260,y1,midX,y2); }); });
              filteredTags.forEach(tg=>{ const first=[...tg.firing][0]; const base=(first&&tY.has(first))?tY.get(first):(0); const y1=(base||0)+pad+23; tg.dests.forEach(d=>{ const key=d.vendor+':'+d.id; const y2=(destY.get(key)||0)+pad+23; edge(midX+320,y1,rightX,y2); }); });
            }

            draw();

            const legend = el('div');

        const info = [
          ['Name', cv.container?.name],
          ['Public ID', cv.container?.publicId],
          ['Usage', (cv.container?.usageContext||[]).join(', ')],
          ['Server URL', (cv.container?.taggingServerUrls||[]).join(', ')],
          ['Account', cv.accountId],
          ['Container ID', cv.containerId],
          ['Version ID', cv.containerVersionId],
        ];
        const counts = [
          ['Tags', cv.tag?.length||0],
          ['Triggers', cv.trigger?.length||0],
          ['Variables', cv.variable?.length||0],
          ['Folders', cv.folder?.length||0],
          ['Templates', cv.template?.length||0],
          ['Built-in Vars', cv.builtInVariable?.length||0],
          ['Clients', cv.client?.length||0],
          ['Zones', cv.zone?.length||0],
          ['Transformations', cv.transformation?.length||0],
        ];

        const card1 = el('div','card');
        card1.appendChild(el('div','title','Container'));
        const kv1 = el('div','kv');
        info.forEach(([k,v])=>{ const K=el('div','k',k); const V=el('div','v',fmt(v)); kv1.appendChild(K); kv1.appendChild(V); });
        card1.appendChild(kv1);
        grid.appendChild(card1);

        const card2 = el('div','card');
        card2.appendChild(el('div','title','Counts'));
        const kv2 = el('div','kv');
        counts.forEach(([k,v])=>{ const K=el('div','k',k); const V=el('div','v',String(v)); kv2.appendChild(K); kv2.appendChild(V); });
        card2.appendChild(kv2);
        grid.appendChild(card2);

        const feats = cv.container?.features||{};
        const card3 = el('div','card');
        card3.appendChild(el('div','title','Features'));
        const kv3 = el('div','kv');
        Object.entries(feats).forEach(([k,v])=>{ const K=el('div','k',k); const V=el('div','v',v? 'Yes':'No'); kv3.appendChild(K); kv3.appendChild(V); });
        card3.appendChild(kv3);
        grid.appendChild(card3);
      }

      function renderList(){
        const content = clear(byId('content'));
        const cv = getCV();
        if(!cv){ content.textContent='No data.'; return; }

        // Aggregate items from active layers into a table with type, id, name
        const items = [];
        if(state.activeLayers.has('tags')) (cv.tag||[]).forEach(x=>items.push({ _kind:'tag', id:x.tagId, name:x.name, type:x.type, raw:x }));
        if(state.activeLayers.has('triggers')) (cv.trigger||[]).forEach(x=>items.push({ _kind:'trigger', id:x.triggerId, name:x.name, type:x.type, raw:x }));
        if(state.activeLayers.has('variables')) (cv.variable||[]).forEach(x=>items.push({ _kind:'variable', id:x.variableId, name:x.name, type:x.type, raw:x }));
        if(state.activeLayers.has('folders')) (cv.folder||[]).forEach(x=>items.push({ _kind:'folder', id:x.folderId, name:x.name, type:'folder', raw:x }));
        if(state.activeLayers.has('templates')) (cv.template||[]).forEach(x=>items.push({ _kind:'template', id:x.templateId, name:x.name, type:x.category || 'template', raw:x }));
        if(state.activeLayers.has('builtInVariable')) (cv.builtInVariable||[]).forEach(x=>items.push({ _kind:'builtInVariable', id:x.name, name:x.name, type:'builtIn', raw:x }));
        if(state.activeLayers.has('clients')) (cv.client||[]).forEach(x=>items.push({ _kind:'client', id:x.clientId, name:x.name, type:x.type, raw:x }));
        if(state.activeLayers.has('transformations')) (cv.transformation||[]).forEach(x=>items.push({ _kind:'transformation', id:x.transformationId, name:x.name, type:x.type, raw:x }));
        if(state.activeLayers.has('zones')) (cv.zone||[]).forEach(x=>items.push({ _kind:'zone', id:x.zoneId, name:x.name, type:'zone', raw:x }));
        if(state.activeLayers.has('consent')) items.push({ _kind:'consent', id:'consent', name:'Consent Settings', type:'consent', raw: cv.container?.features||{} });

        // Search filter
        const q = state.search;
        const filtered = q? items.filter(it=>{
          return (it.id&&String(it.id).toLowerCase().includes(q)) ||
                 (it.name&&it.name.toLowerCase().includes(q)) ||
                 (it.type&&String(it.type).toLowerCase().includes(q));
        }): items;

        const table = el('table','table');
        const thead = el('thead');
        const thr = el('tr');
        ['Kind','ID','Name','Type','Extra'].forEach(h=>{ const th=el('th','',h); thr.appendChild(th); });
        thead.appendChild(thr); table.appendChild(thead);
        const tbody = el('tbody');
        filtered.forEach(it=>{
          const tr = el('tr');
          tr.onclick = ()=> inspect(it);
          const extra = (it._kind==='tag')? classifyTag(it.raw): '';
          [it._kind, it.id||'', it.name||'', it.type||'', extra].forEach((v,i)=>{
            const td = el('td', i===1? 'nowrap':'', fmt(v));
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        content.appendChild(table);
      }

      function inspect(item){
        byId('inspectTitle').textContent = item.name || String(item.id);
        byId('inspectType').textContent = item._kind + (item.type? ' · '+item.type:'');
        byId('inspectStatus').textContent = '';
        const raw = item.raw;
        const json = JSON.stringify(raw, null, 2);
        byId('inspectBody').textContent = json;
      }

      // Tag Assistant (events layer)
      async function loadEventChunks(){
        // Resilient sequential manifest: keep loading until several consecutive misses
        const base = 'chunked_output/tag_assistant_messerattach_com_2025_12_24_messages_chunk_';
        const chunks = [];
        let i = 1; let misses = 0; const MAX_MISSES = 5; const MAX_FILES = 2000;
        while(i <= MAX_FILES && misses < MAX_MISSES){
          try {
            const res = await fetch(base + i + '.json');
            if(res.ok){
              const j = await res.json();
              chunks.push(j);
              misses = 0;
            } else {
              misses++;
            }
          } catch(e){ misses++; }
          i++;
        }
        return chunks;
      }

      let cachedEvents = null;
      async function renderEvents(){
        const content = clear(byId('content'));
        if(!cachedEvents){
          const loading = el('div','muted','Loading Tag Assistant chunks…');
          content.appendChild(loading);
          const chunks = await loadEventChunks();
          const events = [];
          chunks.forEach(ch=>{
            (ch.messages||[]).forEach(m=>{
              const me = m.message||{};
              events.push({
                idx: me.index,
                eventName: me.eventName || me.eventNameKey,
                title: me.title,
                consent: me.consentData?.consentStatus,
                tags: (me.tagInfo||[]).map(t=>({name: t.displayName||t.name, type: t.publicId||t.type})),
                raw: m
              });
            });
          });
          events.sort((a,b)=> (a.idx||0)-(b.idx||0));
          cachedEvents = { events, stat: { chunks: chunks.length, total: events.length } };
        }

        const table = el('table','table');
        const thead = el('thead');
        const thr = el('tr');
        ['#','Event','Tags Fired','Consent'].forEach(h=>{ const th=el('th','',h); thr.appendChild(th); });
        thead.appendChild(thr); table.appendChild(thead);
        const tbody = el('tbody');
        (cachedEvents.events||[]).forEach(ev=>{
          const tr = el('tr');
          tr.onclick = ()=>{
            inspect({ _kind: 'event', id: ev.idx, name: ev.title||ev.eventName, type: 'Tag Assistant', raw: ev.raw });
          };
          const tags = (ev.tags||[]).map(t=>t.name).join(', ');
          const consent = ev.consent? Object.entries(ev.consent).map(([k,v])=>`${k}:${v}`).join(' '): '';
          [String(ev.idx||''), ev.title||ev.eventName||'', tags, consent].forEach(v=>{
            const td = el('td','', v);
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        content.appendChild(table);

        if(cachedEvents && cachedEvents.stat){
          const meta = byId('meta');
          meta.textContent = `Loaded ${cachedEvents.stat.chunks} chunks · ${cachedEvents.stat.total} events`;
        }
      }

      // Graph view with vendor/trigger filters and Destinations column
      function renderGraph(cv){
        const content = clear(byId('content'));

        // Controls
        const controls = el('div','row');
        controls.style.margin='6px 0 10px';
        const search = el('input');
        search.placeholder = 'Filter triggers…';
        search.style.flex='1'; search.style.background='#0d131b'; search.style.color='var(--text)';
        search.style.border='1px solid #243140'; search.style.borderRadius='8px'; search.style.padding='6px 8px';
        controls.appendChild(search);
        const vendorsWrap = el('div','row'); vendorsWrap.style.flexWrap='wrap'; vendorsWrap.style.gap='6px'; vendorsWrap.style.marginLeft='8px';
        controls.appendChild(vendorsWrap);
        content.appendChild(controls);

        // Data
        const triggers = (cv.trigger||[]).map(t=>({ id: t.triggerId, name: t.name||('Trigger '+t.triggerId), type: t.type, raw: t }));
        const tagsRaw = (cv.tag||[]);
        const tags = tagsRaw.map(t=>({ id: t.tagId, name: t.name||('Tag '+t.tagId), type: t.type, vendor: classifyTag(t), firing: new Set(t.firingTriggerId||[]), dests: deriveDestinations(t), raw: t }));
        const vendorSet = Array.from(new Set(tags.map(t=>t.vendor))).filter(Boolean);
        const vendorState = new Map(vendorSet.map(v=>[v,true]));

        // Build vendor checkboxes
        vendorSet.forEach(v=>{
          const lab = el('label','pill-sm'); lab.style.cursor='pointer';
          const cb = el('input'); cb.type='checkbox'; cb.checked=true; cb.style.marginRight='6px'; cb.onchange=()=>{ vendorState.set(v, cb.checked); draw(); };
          lab.appendChild(cb); lab.appendChild(document.createTextNode(v));
          vendorsWrap.appendChild(lab);
        });

        search.oninput = ()=> draw();

        // Stage
        const wrapper = el('div');
        wrapper.style.border = '1px solid #1b2636';
        wrapper.style.borderRadius = '10px';
        wrapper.style.height = '70vh';
        wrapper.style.background = '#0d131b';
        wrapper.style.position = 'relative';
        content.appendChild(wrapper);

        const svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('width','100%'); svg.setAttribute('height','100%'); svg.style.position='absolute'; svg.style.inset='0';
        const g = document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(g); wrapper.appendChild(svg);
        let scale=1, tx=0, ty=0; function update(){ g.setAttribute('transform',`translate(${tx},${ty}) scale(${scale})`);} update();
        let drag=false, sx=0, sy=0, stx=0, sty=0;
        wrapper.addEventListener('pointerdown', e=>{ drag=true; sx=e.clientX; sy=e.clientY; stx=tx; sty=ty; wrapper.setPointerCapture(e.pointerId); });
        wrapper.addEventListener('pointermove', e=>{ if(!drag) return; tx=stx+(e.clientX-sx); ty=sty+(e.clientY-sy); update(); });
        wrapper.addEventListener('pointerup', ()=> drag=false);
        wrapper.addEventListener('wheel', e=>{ e.preventDefault(); const ds=e.deltaY<0?1.1:0.9; scale=Math.min(3,Math.max(0.3,scale*ds)); update(); }, {passive:false});

        function color(v){ const m={'Google Analytics':'#7cc0ff','Google Ads':'#72f0c4','LinkedIn Insight':'#9d8bff','Meta Pixel':'#ff8bbd','Custom HTML':'#ffd166','Custom Template':'#8be38b'}; return m[v]||'#e6eef8'; }

        function draw(){
          while(g.firstChild) g.removeChild(g.firstChild);
          const q = search.value.trim().toLowerCase();
          const trigList = triggers.filter(t=>!q || (t.name||'').toLowerCase().includes(q));
          const tY = new Map(); trigList.forEach((t,i)=> tY.set(t.id, i*90));
          const filteredTags = tags.filter(t=> vendorState.get(t.vendor));
          const byTrigger = new Map(); trigList.forEach(t=>byTrigger.set(t.id, []));
          filteredTags.forEach(tg=> tg.firing.forEach(trid=>{ if(byTrigger.has(trid)) byTrigger.get(trid).push(tg); }));
          const destMap = new Map();
          filteredTags.forEach(tg=> tg.dests.forEach(d=>{ const key=d.vendor+':'+d.id; if(!destMap.has(key)) destMap.set(key,{key,label:d.label,vendor:d.vendor}); }));
          const destList = Array.from(destMap.values());
          const destY = new Map(); destList.forEach((d,i)=> destY.set(d.key, i*90));

          const pad=20, leftX=pad, midX=360, rightX=720;

          function node(x,y,w,h,label,sub,fill,onClick){
            const r=document.createElementNS('http://www.w3.org/2000/svg','rect'); r.setAttribute('x',x); r.setAttribute('y',y);
            r.setAttribute('rx','8'); r.setAttribute('ry','8'); r.setAttribute('width',w); r.setAttribute('height',h);
            r.setAttribute('fill',fill); r.setAttribute('stroke','#243140'); r.setAttribute('stroke-width','1'); r.style.cursor='pointer'; r.addEventListener('click',onClick); g.appendChild(r);
            const t1=document.createElementNS('http://www.w3.org/2000/svg','text'); t1.setAttribute('x',x+10); t1.setAttribute('y',y+18); t1.setAttribute('fill','#0b0f14'); t1.setAttribute('font-size','12'); t1.setAttribute('font-weight','600'); t1.textContent=label; g.appendChild(t1);
            const t2=document.createElementNS('http://www.w3.org/2000/svg','text'); t2.setAttribute('x',x+10); t2.setAttribute('y',y+34); t2.setAttribute('fill','#0b0f14'); t2.setAttribute('font-size','11'); t2.textContent=sub; g.appendChild(t2);
          }
          function edge(x1,y1,x2,y2){ const p=document.createElementNS('http://www.w3.org/2000/svg','path'); const mx=(x1+x2)/2; const d=`M ${x1} ${y1} C ${mx} ${y1}, ${mx} ${y2}, ${x2} ${y2}`; p.setAttribute('d',d); p.setAttribute('fill','none'); p.setAttribute('stroke','#32465e'); p.setAttribute('stroke-width','1.5'); g.appendChild(p); }

          trigList.forEach(tr=>{ const y=(tY.get(tr.id)||0)+pad; node(leftX,y,280,46,tr.name,tr.type,'#72f0c4',()=>inspect({_kind:'trigger',id:tr.id,name:tr.name,type:tr.type,raw:tr.raw})); });
          const tagY=new Map(); filteredTags.forEach((tg,i)=>{ const first=[...tg.firing][0]; const base=(first&&tY.has(first))?tY.get(first):i*90; tagY.set(tg.id,base); const y=(base||0)+pad; node(midX,y,320,46,tg.name,tg.vendor,color(tg.vendor),()=>inspect({_kind:'tag',id:tg.id,name:tg.name,type:tg.type,raw:tg.raw})); });
          destList.forEach(d=>{ const y=(destY.get(d.key)||0)+pad; node(rightX,y,300,46,d.label,d.vendor,color(d.vendor),()=>inspect({_kind:'destination',id:d.key,name:d.label,type:d.vendor,raw:d})); });
          trigList.forEach(tr=>{ const y1=(tY.get(tr.id)||0)+pad+23; const list=(byTrigger.get(tr.id)||[]); list.forEach(tg=>{ const y2=(tagY.get(tg.id)||0)+pad+23; edge(leftX+280,y1,midX,y2); }); });
          filteredTags.forEach(tg=>{ const y1=(tagY.get(tg.id)||0)+pad+23; tg.dests.forEach(d=>{ const key=d.vendor+':'+d.id; const y2=(destY.get(key)||0)+pad+23; edge(midX+320,y1,rightX,y2); }); });

          const legend = el('div'); legend.style.position='absolute'; legend.style.right='10px'; legend.style.top='10px'; legend.style.background='#0b1118'; legend.style.border='1px solid #243140'; legend.style.borderRadius='8px'; legend.style.padding='8px 10px'; legend.style.fontSize='12px';
          legend.innerHTML='<b>Legend</b><br/>'+
            '<span style="color:#72f0c4">■</span> Trigger &nbsp;'+
            '<span style="color:#7cc0ff">■</span> GA &nbsp;'+
            '<span style="color:#72f0c4">■</span> Google Ads &nbsp;'+
            '<span style="color:#9d8bff">■</span> LinkedIn &nbsp;'+
            '<span style="color:#ff8bbd">■</span> Meta &nbsp;'+
            '<span style="color:#ffd166">■</span> Custom HTML';
          wrapper.appendChild(legend);
        }

        draw();
      }

      loadContainers();
    </script>
  </body>
  </html>
